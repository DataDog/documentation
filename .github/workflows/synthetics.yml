name: Preview Synthetics
on: [pull_request]

# Stop the current running job if a new push is made to the PR
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  synthetic_testing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Extract branch name
        shell: bash
        run: echo "branch=$(echo ${{ github.event.pull_request.head.ref }})" >>$GITHUB_OUTPUT
        id: extract_branch

      - name: Echo brnach name
        shell: bash
        run: echo ${{steps.extract_branch.outputs.branch}}

      - name: Check preview status
        id: check-status
        run: |
          CHECK_SUITE_URL="https://api.github.com/repos/DataDig/documentation/commits/${{ github.sha }}/check-suites"
          for i in {1..10}
          do
            status="$(curl -H 'Accept: application/vnd.github.v3+json' -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' $CHECK_SUITE_URL | jq -r '.check_suites // [] | .[] | .check_runs // [] | .[] | select(.app.slug=="dd-gitlab" and .name=="build_preview") | .status')"
            if [[ "$status" == "completed" ]]; then
              echo "Preview build complete, moving on..."
              break
            else
              echo "Waiting for check to complete..."
              sleep 60
            fi
            if [[ $i -eq 10 && "$status" != "completed" ]]; then
              echo "There was an issue with the preview build"
              exit 1
            fi
          done

      - name: Run Datadog Synthetic tests
        uses: DataDog/synthetics-ci-github-action@v0.11.0
        env:
          CI_COMMIT_REF_NAME: ${{steps.extract_branch.outputs.branch}}
        with:
          api_key: ${{secrets.DD_API_KEY}}
          app_key: ${{secrets.DD_APP_KEY}}
          config_path: './datadog-ci.preview.json'