on:
  schedule:
    # At 08:00 on every day-of-week from Monday through Friday.
    - cron: '0 8 * * 1-5'

permissions: {}
jobs:
  synthetics-worker-version:
    permissions:
      contents: write # for git push
      pull-requests: write # to create pull request      
    runs-on: ubuntu-latest
    name: Find latest synthetics-worker version
    steps:
      - uses: actions/checkout@v4

      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.DOCS_GH_APP_ID }}
          private-key: ${{ secrets.DOCS_GH_APP_PRIVATE_KEY }}

      - uses: actions/setup-python@v5.1.0
        with:
          python-version: '3.11'
      - run: pip install requests semver defusedxml

      - name: Find latest synthetic-worker version
        id: set-worker-version
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          python local/bin/py/version_getter.py
      
      - uses: actions/checkout@v4
      - name: Write version
        run: |-
          git config user.name documentation-ci
          git config user.email documentation-ci@datadoghq.com
          git add ./data/synthetics-worker-versions.json
          git commit -m "(Automated) Bump synthetics-worker version"
          git push -f origin HEAD:refs/heads/synthetics-worker/versions
      - uses: actions/github-script@v7
        name: Propose change with latest versions
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          result-encoding: string
          script: |
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "(Automated) Bump synthetics-worker version",
              body: "### Merge instructions\n- [x] Please merge after reviewing",
              head: "synthetics-worker/versions",
              base: "master",
              maintainer_can_modify: true
            })
  
