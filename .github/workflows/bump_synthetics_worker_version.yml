on:
  schedule:
    # At 08:00 on every day-of-week from Monday through Friday.
    - cron: "0 8 * * 1-5"
  workflow_dispatch: # allows manual trigger

jobs:
  synthetics_worker_version:
    permissions:
      contents: write # for git push
      id-token: write # Needed to federate tokens.
      pull-requests: write # Action creates a PR.
    runs-on: ubuntu-latest
    name: Find latest synthetics-worker version
    steps:
      - uses: DataDog/dd-octo-sts-action@acaa02eee7e3bb0839e4272dacb37b8f3b58ba80 # v1.0.3
        id: octo-sts
        with:
          scope: DataDog/documentation
          policy: self.bump-synthetics-worker-version.create-pr
        
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          persist-credentials: false

      - uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
        with:
          python-version: "3.11"
      - run: pip install requests semver

      - name: Find and write latest version
        id: write-version
        run: |
          python local/bin/py/version_getter.py \
          --url "https://ddsynthetics-windows.s3.amazonaws.com/installers.json" \
          --file-name "synthetics_worker_versions.json"

      - name: Save modified file
        run: |
          mkdir -p $RUNNER_TEMP/temp
          cp ./data/synthetics_worker_versions.json $RUNNER_TEMP/temp/

      - name: echo new version
        run: echo ${{ steps.write-version.outputs.new_version }}

      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          persist-credentials: true

      - name: Restore modified file
        run: |
          cp $RUNNER_TEMP/temp/synthetics_worker_versions.json ./data/

      - name: Write version
        if: steps.write-version.outputs.new_version == 'true'
        run: |-
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ./data/synthetics_worker_versions.json
          git commit -m "(Automated) Bump synthetic worker version"
          git push -f origin HEAD:refs/heads/automatic-version-update/synthetics-worker

      - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        name: Propose change with latest versions
        if: steps.write-version.outputs.new_version == 'true'
        with:
          github-token: ${{ steps.octo-sts.outputs.token }}
          result-encoding: string
          script: |
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "(Automated) Bump version",
              body: "### Merge instructions\n- **Please merge this PR after approving!**",
              head: "automatic-version-update/synthetics-worker",
              base: "master",
              maintainer_can_modify: true
            })
