stages:
  - build
  - pre-deploy
  - deploy
  - post-deploy
  - cleanup

variables:
  BUILD_IMAGE: "mstbbs/docker-dd-docs:0.2"
  PREVIEW_CONFIG: "config/preview.yaml"
  LIVE_CONFIG: "config/live.yaml"
  ARTIFACT_RESOURCE: "public"
  LIVE_DOMAIN: "https://dmin7ss6aif3e.cloudfront.net/"

# ================== copy scripts =============== #
before_script:
  - find gitlab/bin/ -type f -exec cp {} /usr/local/bin \;  # load scripts
  - find gitlab/etc/ -type f -exec cp {} /etc \;  # load configs
  - source /usr/local/bin/helpers.sh  # source helpers so they are available in the container

# ================== templates ================== #
.base_template: &base_template
  image: ${BUILD_IMAGE}
  tags:
    - docker
  only:
    - branches

# ================== preview ================== #
# If the branch has a name of <slack-user>/<feature-name> then ci will build a preview site
build_preview:
  <<: *base_template
  stage: build
  environment: "preview"
  variables:
    BUCKET: ${PREVIEW_BUCKET}
    URL: ${PREVIEW_DOMAIN}
    CONFIG: ${PREVIEW_CONFIG}
    MESSAGE: ":gift_heart: Your preview site is available!\nNow running tests..."
  script:
    - post_dd_event "documentation deploy ${CI_COMMIT_REF_NAME} started" "${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}" "info"
    - version_static_assets
    - placehold_translations
    - sync_integration_metrics
    - build_hugo_site
    - minify_html
    - push_site_to_s3
    - notify_slack "${MESSAGE}"
    - remove_static_from_repo
    - create_artifact
  only:
    - /.+?\/[a-zA-Z0-9_-]+/

test_preview_images:
  <<: *base_template
  stage: post-deploy
  environment: "preview"
  variables:
    URL: ${PREVIEW_DOMAIN}
  script:
    - pull_artifact_from_s3
    - test_site_links "images" "${URL}" "True" "True" "True"
  only:
    - /.+?\/[a-zA-Z0-9_-]+/

test_preview_static:
  <<: *base_template
  stage: post-deploy
  environment: "preview"
  variables:
    URL: ${PREVIEW_DOMAIN}
  script:
    - pull_artifact_from_s3
    - test_site_links "static" "${URL}" "True" "True" "True"
  only:
    - /.+?\/[a-zA-Z0-9_-]+/

test_preview_links:
  <<: *base_template
  stage: post-deploy
  environment: "preview"
  variables:
    URL: ${PREVIEW_DOMAIN}
  script:
    - pull_artifact_from_s3
    - test_site_links "links" "${URL}" "True" "True" "True"
  only:
    - /.+?\/[a-zA-Z0-9_-]+/

# ================== live ================== #
build_live:
  <<: *base_template
  stage: build
  environment: "live"
  variables:
    CONFIG: ${LIVE_CONFIG}
    BUCKET: ${LIVE_BUCKET}
    URL: ${LIVE_DOMAIN}
  script:
    - post_dd_event "documentation deploy ${CI_COMMIT_REF_NAME} started" "${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}" "info"
    - version_static_assets
    - placehold_translations
    - sync_integration_metrics
    - build_hugo_site
    - minify_html
    - remove_static_from_repo
    - create_artifact
  only:
    - docs-hugo

deploy_live:
  <<: *base_template
  stage: deploy
  environment: "live"
  variables:
    BUCKET: ${LIVE_BUCKET}
    MESSAGE: ":fiestaparrot: New production build is live! :fiestaparrot:\nPost deploy tests running..."
  script:
    - pull_artifact_from_s3
    - push_site_to_s3
    - notify_slack "${MESSAGE}"
  only:
    - docs-hugo

test_live_images:
  <<: *base_template
  stage: post-deploy
  environment: "live"
  variables:
    URL: ${LIVE_DOMAIN}
  script:
    - pull_artifact_from_s3
    - test_site_links "images" "${URL}" "True" "False" "True"
  only:
    - docs-hugo

test_live_links:
  <<: *base_template
  stage: post-deploy
  environment: "live"
  variables:
    URL: ${LIVE_DOMAIN}
  script:
    - pull_artifact_from_s3
    - test_site_links "links" "${URL}" "True" "False" "False"
  only:
    - docs-hugo

test_live_static:
  <<: *base_template
  stage: post-deploy
  environment: "live"
  variables:
    URL: ${LIVE_DOMAIN}
  script:
    - pull_artifact_from_s3
    - test_site_links "static" "${URL}" "True" "False" "False"
  only:
    - docs-hugo

rollback_live:
  <<: *base_template
  stage: cleanup
  environment: "live"
  when: on_failure
  variables:
    BUCKET: ${LIVE_BUCKET}
  script:
    - rollback_env
  only:
    - docs-hugo

tag_successful_live_pipeline:
  <<: *base_template
  stage: cleanup
  environment: "live"
  when: on_success
  script:
    - tag_successful_pipeline
  only:
    - docs-hugo

post_success_event_to_dd_live:
  <<: *base_template
  stage: cleanup
  environment: "live"
  when: on_success
  script:
    - post_dd_event "documentation deploy ${CI_COMMIT_REF_NAME} succeeded" "${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}" "success"
    - post_dd_metric "documentation.pipeline.completed" "1" "" "success"
  only:
    - docs-hugo

post_failure_event_to_dd_live:
  <<: *base_template
  stage: cleanup
  environment: "live"
  when: on_failure
  script:
    - post_dd_event "documentation deploy ${CI_COMMIT_REF_NAME} failed" "${CI_PROJECT_URL}/pipelines/${CI_PIPELINE_ID}" "error"
    - post_dd_metric "documentation.pipeline.completed" "0" "" "failure"
  only:
    - docs-hugo
