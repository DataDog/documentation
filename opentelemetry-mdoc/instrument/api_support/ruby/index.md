---
title: Ruby Custom Instrumentation using the OpenTelemetry API
description: Datadog, the leading service for cloud-scale monitoring.
breadcrumbs: >-
  Docs > OpenTelemetry in Datadog > Instrument Your Applications > OpenTelemetry
  API Support > Ruby Custom Instrumentation using the OpenTelemetry API
---

# Ruby Custom Instrumentation using the OpenTelemetry API

## Overview{% #overview %}

Datadog tracing libraries provide an implementation of the [OpenTelemetry API](https://opentelemetry.io/docs/reference/specification/trace/api) for instrumenting your code. This means you can maintain vendor-neutral instrumentation of all your services, while still taking advantage of Datadog's native implementation, features, and products. You can configure it to generate Datadog-style spans and traces to be processed by the Datadog tracing library for your language, and send those to Datadog.

By instrumenting your code with OpenTelemetry API:

- Your code remains free of vendor-specific API calls.
- Your code does not depend on Datadog tracing libraries at compile time (only runtime).

Replace the OpenTelemetry SDK with the Datadog tracing library in the instrumented application, and the traces produced by your running code can be processed, analyzed, and monitored alongside Datadog traces and in Datadog proprietary products.

The Datadog tracing library, when configured as described here, accepts the spans and traces generated by OpenTelemetry-instrumented code, processes the telemetry, and sends it to Datadog. You can use this approach, for example, if your code has already been instrumented with the OpenTelemetry API, or if you want to instrument using the OpenTelemetry API, and you want to gain the benefits of using the Datadog tracing libraries without changing your code.

If you're looking for a way to instrument your code with OpenTelemetry and then send span data to Datadog *without going through the Datadog tracing library*, see [OpenTelemetry in Datadog](http://localhost:1313/opentelemetry/).

## Requirements and limitations{% #requirements-and-limitations %}

- Datadog Ruby tracing library `dd-trace-rb` version 1.9.0 or greater.
- Gem version support 1.1.0 or greater.

The following OpenTelemetry features implemented in the Datadog library as noted:

| Feature                                                                                                             | Support notes                                                                                                                                                                               |
| ------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [OpenTelemetry Context propagation](https://opentelemetry.io/docs/instrumentation/ruby/manual/#context-propagation) | [Datadog and W3C Trace Context header formats](http://localhost:1313/tracing/trace_collection/trace_context_propagation/) are enabled by default.                                           |
| [Span processors](https://opentelemetry.io/docs/reference/specification/trace/sdk/#span-processor)                  | Unsupported                                                                                                                                                                                 |
| [Span Exporters](https://opentelemetry.io/docs/reference/specification/trace/sdk/#span-exporter)                    | Unsupported                                                                                                                                                                                 |
| `OpenTelemetry.logger`                                                                                              | `OpenTelemetry.logger` is set to the same object as `Datadog.logger`. Configure through [custom logging](http://localhost:1313/tracing/trace_collection/dd_libraries/ruby/#custom-logging). |
| Trace/span [ID generators](https://opentelemetry.io/docs/reference/specification/trace/sdk/#id-generators)          | ID generation is performed by the tracing library, with support for [128-bit trace IDs](http://localhost:1313/opentelemetry/guide/otel_api_tracing_interoperability/).                      |

## Configuring OpenTelemetry to use the Datadog tracing library{% #configuring-opentelemetry-to-use-the-datadog-tracing-library %}

1. Add your desired manual OpenTelemetry instrumentation to your Ruby code following the [OpenTelemetry Ruby Manual Instrumentation documentation](https://opentelemetry.io/docs/instrumentation/ruby/manual/). **Important!** Where those instructions indicate that your code should call the OpenTelemetry SDK, call the Datadog tracing library instead.

1. Add the `datadog` gem to your Gemfile:

   ```ruby
   source 'https://rubygems.org'
   gem 'datadog' # For dd-trace-rb v1.x, use the `ddtrace` gem.
   ```

1. Install the gem by running `bundle install`.

1. Add the following lines to your OpenTelemetry configuration file:

   ```ruby
   require 'opentelemetry/sdk'
   require 'datadog/opentelemetry'
   ```

1. Add a configuration block to your application where you can activate integrations and change tracer settings. Without additional configuration here, only code you have instrumented with OpenTelemetry is traced:

   ```ruby
   Datadog.configure do |c|
     ...
   end
   ```

Using this block you can:

   - [Add additional Datadog configuration settings](http://localhost:1313/tracing/trace_collection/dd_libraries/ruby/#additional-configuration)
   - [Activate or reconfigure Datadog instrumentation](http://localhost:1313/tracing/trace_collection/dd_libraries/ruby#integration-instrumentation)

OpenTelemetry configuration can be changed separately, using the [`OpenTelemetry::SDK.configure` block](https://opentelemetry.io/docs/languages/ruby/getting-started/#instrumentation).

Datadog combines these OpenTelemetry spans with other Datadog APM spans into a single trace of your application. It supports [integration instrumentation](http://localhost:1313/tracing/trace_collection/dd_libraries/ruby#integration-instrumentation) and [OpenTelemetry Automatic instrumentation](https://opentelemetry.io/docs/languages/ruby/libraries/) also.

## Adding span events{% #adding-span-events %}

{% alert level="info" %}
Adding span events requires SDK version 2.3.0 or higher.
{% /alert %}

You can add span events using the `add_event` API. This method requires a `name` parameter and optionally accepts `attributes` and `timestamp` parameters. The method creates a new span event with the specified properties and associates it with the corresponding span.

- **Name** [*required*]: A string representing the event's name.
- **Attributes** [*optional*]: Zero or more key-value pairs with the following properties:
  - The key must be a non-empty string.
  - The value can be either:
    - A primitive type: string, Boolean, or number.
    - A homogeneous array of primitive type values (for example, an array of strings).
  - Nested arrays and arrays containing elements of different data types are not allowed.
- **Timestamp** [*optional*]: A UNIX timestamp representing the event's occurrence time. Expects `seconds(Float)`.

The following examples demonstrate different ways to add events to a span:

```ruby
span.add_event('Event With No Attributes')
span.add_event(
  'Event With All Attributes',
  attributes: { 'int_val' => 1, 'string_val' => 'two', 'int_array' => [3, 4], 'string_array' => ['5', '6'], 'bool_array' => [false, true]}
)
```

Read the [OpenTelemetry](https://opentelemetry.io/docs/specs/otel/trace/api/#add-events) specification for more information.

### Recording exceptions{% #recording-exceptions %}

To record exceptions, use the `record_exception` API. This method requires an `exception` parameter and optionally accepts a UNIX `timestamp` parameter. It creates a new span event that includes standardized exception attributes and associates it with the corresponding span.

The following examples demonstrate different ways to record exceptions:

```ruby
span.record_exception(
  StandardError.new('Error Message')
)
span.record_exception(
  StandardError.new('Error Message'),
  attributes: { 'status' => 'failed' }
)
```

Read the [OpenTelemetry](https://opentelemetry.io/docs/specs/otel/trace/api/#record-exception) specification for more information.

## Further Reading{% #further-reading %}

- [Explore your services, resources, and traces](http://localhost:1313/tracing/glossary/)
- [Interoperability of OpenTelemetry API and Datadog instrumented traces](http://localhost:1313/opentelemetry/guide/otel_api_tracing_interoperability)
