多くの種類のログは、長期間にわたって KPI などの傾向を追跡するためのテレメトリーに使用されることを目的としています。ログからメトリクスを生成することは、大量のログ (CDN ログ、VPC フローログ、ファイアウォールログ、ネットワークログなど) のログデータを要約するうえで費用対効果の高い方法です。クエリに一致するログの Count メトリクス、またはログに含まれる数値の Distribution メトリクス (リクエスト時間など) を生成するには、generate metricsプロセッサーを使用します。

**注**: 生成されるメトリクスは[カスタムメトリクス][10031]であり、それに応じて課金されます。詳細については、[Custom Metrics Billing][10032]を参照してください。

このプロセッサーをセットアップするには、次の手順に従います。

[**Manage Metrics**] をクリックして、新しいメトリクスを作成するか、既存のメトリクスを編集します。サイドパネルが開きます。

- まだメトリクスを作成していない場合は、[メトリクスの追加](#add-a-metric)セクションの説明に従いメトリクスのパラメーターを入力して、メトリクスを作成してください。
- メトリクスをすでに作成している場合は、概要テーブルのメトリクスの行をクリックして、メトリクスを編集または削除します。検索バーを使用して特定のメトリクスを名前で検索し、メトリクスを選択して編集または削除します。別のメトリクスを追加するには、[**Add Metric**] をクリックします。

##### メトリクスの追加

 1. [フィルタークエリ](#filter-query-syntax)を入力します。指定されたフィルタークエリに一致するログのみが処理されます。フィルタークエリに一致するかどうかにかかわらず、すべてのログはパイプラインの次のステップに送られます。**注**: 1 つのプロセッサーで複数のメトリクスを生成できるため、メトリクスごとに異なるフィルタークエリを定義できます。
1. メトリクスの名前を入力します。
1. [**Define parameters**] セクションで、メトリクスタイプ (count、gauge、distribution) を選択します。[Count メトリクスの例](#count-metric-example)と[Distribution メトリクスの例](#distribution-metric-example)を参照してください。詳しくは[メトリクスタイプ](#metrics-types)も参照してください。
   - Gauge および Distribution メトリクスタイプの場合、生成されるメトリクスの値として使用する数値 (または数値として解析可能な文字列) を含むログフィールドを選択します。
   - Distribution メトリクスタイプの場合、ログフィールドの値として数値 (解析可能) の配列を使用できます。この配列は、生成されるメトリクスのサンプルセットとして使用されます。
   - [**Group by**] フィールドは、メトリクス値のグループ化方法を決定します。たとえば、数百のホストが 4 つのリージョンに分散している場合、リージョンごとにグループ化することで、リージョンごとに 1 つの線でグラフ化できます。[**Group by**] 設定にリストされたフィールドは、構成されているメトリクスのタグとして設定されます。
1. [**Add Metric**] をクリックします。

##### メトリクスタイプ

ログについて次に示すタイプのメトリクスを生成できます。詳細については、[Metrics Types][10033]および[Distributions][10034]のドキュメントを参照してください。

| Metric type| 説明| 例|
|----------|----------|----------|
| COUNT| ある時間間隔内に発生したイベントの総数を示します。この値はゼロにリセットできますが、減らすことはできません。| `status:error` を含むログの数をカウントする。|
| GAUGE| ある時間間隔におけるイベントのスナップショットを示します。| 本番環境のすべてのログに対する各ホストの最新の CPU 使用率を測定する。|
| DISTRIBUTION| 1 つの時間間隔における、分散型インフラストラクチャー全体で計算された値の集合のグローバルな統計分布を示します。| API 呼び出しにかかる平均時間を測定する。|

##### Count メトリクスの例

この `status:error` ログの例:

```
{"status": "error", "env": "prod", "host": "ip-172-25-222-111.ec2.internal"}
```

`"status":"error"` を含むログの数をカウントし、`env` および `host` でグループ化するCount メトリクスを作成するには、次の情報を入力します。

| 入力パラメーター| 値|
|----------|----------|
| Filter query| `@status:error`|
| Metric name| `status_error_total`|
| Metric type| Count|
| Group by| `env`、`prod`|

##### Distribution メトリクスの例

この API レスポンスログの例の場合:

```
{
    "timestamp": "2018-10-15T17:01:33Z",
    "method": "GET",
    "status": 200,
    "request_body": "{"information"}",
    "response_time_seconds: 10
}
```

API 呼び出しにかかる平均時間を測定する Distribution メトリクスを作成するには、次の情報を入力します。

| 入力パラメーター| 値|
|----------|----------|
| Filter query| `@method`|
| Metric name| `status_200_response`|
| Metric type| Distribution|
| Select a log attribute| `response_time_seconds`|
| Group by| `method`|

[10031]: /metrics/custom_metrics/
[10032]: /account_management/billing/custom_metrics/
[10033]: /metrics/types/
[10034]: /metrics/distributions/
