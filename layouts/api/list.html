{{ define "main" }}
{{ $context := . }}
{{ $version := .Params.version | default "v1" }}

{{/* Get the actual API data structure */}}
{{ $apiData := index $context.Site.Data.api $version }}
{{ $codeExampleLookup := $apiData.CodeExamples }}
{{ $endpoints := $apiData.endpoints }}

{{/* Generate resources once at the top */}}
{{ if not (.Scratch.Get "api-resources-generated") }}
  {{ partial "api/generate-resources.html" (dict "context" $context "version" $version) }}
  {{ .Scratch.Set "api-resources-generated" true }}
{{ end }}

<div class="api-documentation">
  {{/* Use the correct data structure - iterate through endpoints */}}
  {{ range $endpoints }}
    <div class="api-endpoint" id="{{ .operationId }}">
      <h2>{{ .summary | default .action.summary }}</h2>

      {{/* Use optimized code examples */}}
      {{ $codeResourcePath := printf "api-code-examples/%s.html" .operationId }}
      {{ $codeResource := resources.Get $codeResourcePath }}
      {{ if $codeResource }}
        {{ $codeResource.Content | safeHTML }}
      {{ else }}
        {{/* Fallback to original partial with correct parameters */}}
        {{ partial "api/code-example.html" (dict
          "context" $context
          "operationid" .operationId
          "endpoint" .
          "version" $version
        ) }}
      {{ end }}
    </div>
  {{ end }}
</div>
{{ end }}
