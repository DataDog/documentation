{{- /* Outputs the contents of api/latest pages as a JSON object. */ -}}

{{ $hugo_context := .context }}
{{ $api_v1_data := index $hugo_context.Site.Data.api.v1 "full_spec_deref" }}
{{ $api_v2_data := index $hugo_context.Site.Data.api.v2 "full_spec_deref" }}

{{ range (where $hugo_context.Site.AllPages "Type" "=" "api") }}
    {{ if in .RelPermalink "latest/logs" }}
        {{ $title := .Title }}
        {{ $lang := .Language.Lang }}
        {{ $type := .Type }}
        {{ $tags := .Params.algolia.tags }}
        {{ $rank := .Params.algolia.rank }}
        {{ $permalink := .Permalink }}
        {{ $rel_permalink := .RelPermalink }}

        {{ range $endpoint, $endpoint_data := $api_v2_data.paths }}
            {{ range $endpoint_data }}
                {{ if in .tags $title }}
                    {{ $section_header := .summary }}
                    {{ $section_content := .description }}
                    {{ $full_url := print $permalink "#" ($section_header | anchorize) }}
                    {{ $object_id := md5 $full_url }}

                    {{
                        $hugo_context.Scratch.Add "algoliaindex" (
                            dict "objectID" $object_id
                            "title" $title
                            "section_header" $section_header
                            "content" $section_content
                            "type" $type
                            "rel_permalink" $rel_permalink
                            "full_url" $full_url
                            "language" $lang
                            "tags" $tags
                            "rank" $rank
                        )
                    }}
                {{ end }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}