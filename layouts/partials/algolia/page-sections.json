{{- $hugo_context := .context -}}
{{- $page := .page -}}
{{- $title := .title -}}
{{- $category := .category -}}
{{- $subcategory := .subcategory -}}
{{- $rank := .rank -}}
{{- $section_header := "" -}}
{{- $section_content := "" -}}
{{- $content_array := split $page.Content "<h2" -}}

{{- range $content_array -}}
    {{- if in . "h2" -}}
        {{- $context := print "%s" . | printf "%s%s" "<h2" -}}
        {{- $section_header = index (split (index (split $context "</h2>") 0) ">") 1 -}}
        {{- $section_content_count := len (split $context "<p>") -}}

        {{- $max := 0 -}}
        {{- range (seq 0 $section_content_count) -}}
            {{- $start := add ($max) 0 -}}
            {{- $end := add ($max) 10000 -}}
            {{- if and (lt $end $section_content_count) (gt $max 0) -}}
                {{- $section_content = $context | plainify | htmlUnescape | safeHTML | slice $start $end -}}

                {{- printf "%v" $section_content -}}

                {{- $full_url := print $page.Permalink "#" ($section_header | anchorize) -}}
                {{- $relpermalink := print $page.RelPermalink "#" ($section_header | anchorize) -}}
                {{- $object_id := md5 $full_url -}}

                {{- $hugo_context.Scratch.Add "algoliaindex" (
                    dict "objectID" 
                    $object_id "title" 
                    $title "section_header" 
                    $section_header "content" 
                    $section_content "type" 
                    $page.Type "relpermalink" 
                    $relpermalink "full_url" 
                    $full_url "language" 
                    $page.Language.Lang "category" 
                    $category "subcategory" 
                    $subcategory "rank" 
                    $rank) 
                -}}
            {{- end -}}
            {{- $max = add ($max) 10000 -}}
        {{- end -}}
    {{- end -}}
{{- end -}}