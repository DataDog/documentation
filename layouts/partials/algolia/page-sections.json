{{- /* Creates an algolia json record for each individual section (split by h2 header) of the given page. */ -}}

{{ $hugo_context := .context }}
{{ $page := .page }}
{{ $title := .title }}
{{ $category := .category }}
{{ $subcategory := .subcategory }}
{{ $rank := .rank }}
{{ $section_header := "" }}
{{ $section_content := "" }}
{{ $section_content_words := "" }}
{{ $order := 0 }}

{{ range $element := (slice "h2" "h3" "h4") }}
  {{ $content_array := split $page.Content (print "<" $element) }}
  {{ range $content_array }}
      {{ if in . $element }}
          {{ $context := print "%s" . | printf "%s%s" (print "<" $element) }}
          {{ $section_header = index (split (index (split $context (printf "</%s>" $element)) 0) ">") 1 }}
          {{ $section_content = $context | plainify | htmlUnescape | safeHTML }}
          {{ $section_content_words = (split $section_content " ")}}

          {{ if and (ne $section_header "Further Reading") (ne $section_header "") }}

              {{- $chunked := slice -}}
              {{- $post_len := len $section_content_words -}}
              {{- if gt $post_len 100000 -}}
                  {{ warnf "large %i %q" $post_len $page.File.Filename }}
                  {{- $post_len = 100000 -}}
              {{- end -}}

              {{- range $i := (seq 0 500 $post_len) -}}
                  {{- $chunked = $chunked | append (delimit (first 500 (after $i $section_content_words) ) " " ) -}}
              {{- end -}}

              {{- range $i, $c := $chunked -}}
                  {{ $order = add $order $i }}
                  {{ $full_url := print $page.Permalink "#" ($section_header | anchorize) }}
                  {{ $relpermalink := print $page.RelPermalink "#" ($section_header | anchorize) }}
                  {{- $object_id := (print $page.File.UniqueID "_" $page.File.Lang "_" ($section_header | anchorize) "_" $i) -}}

                  {{-
                      $hugo_context.Scratch.Add "algoliaindex" (
                          dict "objectID" $object_id
                          "title" $title
                          "order" $order
                          "tags" ($page.Params.algolia.tags | default slice)
                          "section_header" $section_header
                          "content" $c
                          "type" $page.Type
                          "relpermalink" $relpermalink
                          "full_url" $full_url
                          "language" $page.Language.Lang
                          "category" $category
                          "subcategory" $subcategory
                          "rank" $rank
                      )
                  -}}
              {{- end -}}
          {{ end }}
          {{ $order = add $order 1 }}
      {{ end }}
  {{ end }}
{{ end }}
