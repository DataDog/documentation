{{- /* Creates an algolia json record for each individual section (split by h2 header) of the given page. */ -}}

{{- $hugo_context := .context -}}
{{- $page := .page -}}
{{- $title := .title -}}
{{- $category := .category -}}
{{- $subcategory := .subcategory -}}
{{- $rank := .rank -}}
{{- $section_header := "" -}}

{{- $context := print "%s" . | printf "%s%s" "<h2" -}}
{{- $section_header = index (split (index (split $context "</h2>") 0) ">") 1 -}}

{{- $chunked := slice -}}
{{- $post_len := len $page.PlainWords -}}

{{- range $i := (seq 0 1000 $post_len) -}}
    {{- $chunked = $chunked | append (delimit (first 1000 (after $i $page.PlainWords) ) " " ) -}}
{{- end -}}

{{- range $i, $c := $chunked -}}
    {{- $full_url := print $page.Permalink "#" ($section_header | anchorize) -}}
    {{- $relpermalink := print $page.RelPermalink "#" ($section_header | anchorize) -}}
    {{- $object_id := (print $page.File.UniqueID "_" $page.File.Lang "_" $i) -}}

    {{- $hugo_context.Scratch.Add "algoliaindex" (
        dict "objectID" $object_id
        "title" $title
        "order" $i
        "date" $page.Date
        "tags" $page.Params.tags
        "section_header" $section_header
        "content" $c
        "type" $page.Type
        "relpermalink" $relpermalink
        "full_url" $full_url
        "language" $page.Language.Lang
        "category" $category
        "subcategory" $subcategory
        "rank" $rank
    ) -}}
{{- end -}}
