{{/*
  Partial: plaintext-content.html
  Purpose: Convert HTML content to well-formatted plaintext with markdown structure
  Usage: {{ partial "plaintext-content.html" .Content }}

  Configuration (in config.yaml):
    params:
      plaintext_date_format: "2006-01-02 15:04:05"  # Custom date format for plaintext files

  Performance: Only processes content if HTML tags are detected, skipping plain text content

  Features:
  - Preserves markdown structure (headings, lists, tables, etc.)
  - Converts images to markdown format with alt text
  - Maintains link formatting
  - Handles nested lists with proper spacing and indentation
  - Dynamic table column detection for proper markdown tables
  - Case-insensitive tag matching
  - Multiline content support
  - Enhanced spacing for better readability
*/}}

{{ $content := . }}

{{/* Only process if content contains relevant HTML tags - performance optimization */}}
{{ if findRE `<(?:img|a|h[1-6]|pre|code|blockquote|table|[uo]l|li|strong|b|em|i|p|div)\b` $content 1 }}

  {{/* Step 1: Pre-process to add spacing markers around block elements */}}
  {{ $content = $content | replaceRE `(?i)(<h[1-6][^>]*?>)` "\n\n§HEADING_START§$1" }}
  {{ $content = $content | replaceRE `(?i)(</h[1-6]>)` "$1§HEADING_END§\n\n" }}
  {{ $content = $content | replaceRE `(?i)(<table[^>]*?>)` "\n\n§TABLE_START§$1" }}
  {{ $content = $content | replaceRE `(?i)(</table>)` "$1§TABLE_END§\n\n" }}
  {{ $content = $content | replaceRE `(?i)(<[uo]l[^>]*?>)` "\n\n§LIST_START§$1" }}
  {{ $content = $content | replaceRE `(?i)(<\/[uo]l>)` "$1§LIST_END§\n\n" }}
  {{ $content = $content | replaceRE `(?i)(<blockquote[^>]*?>)` "\n\n§QUOTE_START§$1" }}
  {{ $content = $content | replaceRE `(?i)(</blockquote>)` "$1§QUOTE_END§\n\n" }}

  {{/* Step 2: Handle paragraphs with better spacing */}}
  {{ if findRE `<p\b` $content 1 }}
    {{ $content = $content | replaceRE `(?is)<p[^>]*?>\s*` "\n\n" }}
    {{ $content = $content | replaceRE `(?is)\s*</p>` "\n\n" }}
  {{ end }}

  {{/* Step 3: Handle images - convert to markdown format with proper escaping */}}
  {{ if findRE `<img\b` $content 1 }}
    {{ $content = $content | replaceRE `(?i)<img[^>]*?\salt\s*=\s*["']([^"']*?)["'][^>]*?\ssrc\s*=\s*["']([^"']*?)["'][^>]*?>` "![$1]($2)" }}
    {{ $content = $content | replaceRE `(?i)<img[^>]*?\ssrc\s*=\s*["']([^"']*?)["'][^>]*?\salt\s*=\s*["']([^"']*?)["'][^>]*?>` "![$2]($1)" }}
    {{ $content = $content | replaceRE `(?i)<img[^>]*?\ssrc\s*=\s*["']([^"']*?)["'][^>]*?>` "![]($1)" }}
  {{ end }}

  {{/* Step 4: Handle links - simplified pattern that works with Go regex */}}
  {{ if findRE `<a\b` $content 1 }}
    {{ $content = $content | replaceRE `(?i)<a[^>]*?\shref\s*=\s*["']([^"']*?)["'][^>]*?>(.*?)</a>` "[$2]($1)" }}
  {{ end }}

  {{/* Step 5: Handle code blocks before inline code to avoid conflicts */}}
  {{ if findRE `<pre\b` $content 1 }}
    {{ $content = $content | replaceRE `(?is)<pre[^>]*?><code[^>]*?>(.*?)</code></pre>` "\n\n```\n$1\n```\n\n" }}
    {{ $content = $content | replaceRE `(?is)<pre[^>]*?>(.*?)</pre>` "\n\n```\n$1\n```\n\n" }}
  {{ end }}

  {{/* Step 6: Handle inline code after blocks */}}
  {{ if findRE `<code\b` $content 1 }}
    {{ $content = $content | replaceRE `(?i)<code[^>]*?>(.*?)</code>` "`$1`" }}
  {{ end }}

  {{/* Step 7: Convert headings with enhanced spacing */}}
  {{ if findRE `<h[1-6]\b` $content 1 }}
    {{ $content = $content | replaceRE `(?is)§HEADING_START§<h1[^>]*?>(.*?)</h1>§HEADING_END§` "\n\n# $1\n========================\n\n" }}
    {{ $content = $content | replaceRE `(?is)§HEADING_START§<h2[^>]*?>(.*?)</h2>§HEADING_END§` "\n\n## $1\n\n" }}
    {{ $content = $content | replaceRE `(?is)§HEADING_START§<h3[^>]*?>(.*?)</h3>§HEADING_END§` "\n\n### $1\n\n" }}
    {{ $content = $content | replaceRE `(?is)§HEADING_START§<h4[^>]*?>(.*?)</h4>§HEADING_END§` "\n\n#### $1\n\n" }}
    {{ $content = $content | replaceRE `(?is)§HEADING_START§<h5[^>]*?>(.*?)</h5>§HEADING_END§` "\n\n##### $1\n\n" }}
    {{ $content = $content | replaceRE `(?is)§HEADING_START§<h6[^>]*?>(.*?)</h6>§HEADING_END§` "\n\n###### $1\n\n" }}
  {{ end }}

  {{/* Step 8: Handle tables with improved processing */}}
  {{ if findRE `<table\b` $content 1 }}
    {{/* Remove table spacing markers and process table content */}}
    {{ $content = $content | replaceRE `(?is)§TABLE_START§<table[^>]*?>(.*?)</table>§TABLE_END§` "\n\n§TABLE§$1§/TABLE§\n\n" }}

    {{/* Process table structure */}}
    {{ $content = $content | replaceRE `(?is)<thead[^>]*?>(.*?)</thead>` "§THEAD§$1§/THEAD§" }}
    {{ $content = $content | replaceRE `(?is)<tbody[^>]*?>(.*?)</tbody>` "§TBODY§$1§/TBODY§" }}
    {{ $content = $content | replaceRE `(?is)<tfoot[^>]*?>(.*?)</tfoot>` "§TFOOT§$1§/TFOOT§" }}

    {{/* Convert table rows */}}
    {{ $content = $content | replaceRE `(?is)<tr[^>]*?>(.*?)</tr>` "§TR§$1§/TR§\n" }}

    {{/* Convert table cells */}}
    {{ $content = $content | replaceRE `(?is)<th[^>]*?>(.*?)</th>` "§TH§$1§/TH§" }}
    {{ $content = $content | replaceRE `(?is)<td[^>]*?>(.*?)</td>` "§TD§$1§/TD§" }}

    {{/* Convert to markdown table format */}}
    {{ $content = $content | replaceRE `(?s)§TABLE§(.*?)§/TABLE§` "$1" }}
    {{ $content = $content | replaceRE `(?s)§THEAD§(.*?)§/THEAD§` "$1§HEADER_SEPARATOR§" }}
    {{ $content = $content | replaceRE `(?s)§TBODY§(.*?)§/TBODY§` "$1" }}
    {{ $content = $content | replaceRE `(?s)§TFOOT§(.*?)§/TFOOT§` "$1" }}

    {{/* Process table rows and cells */}}
    {{ $content = $content | replaceRE `§TR§(.+?)§/TR§` "| $1 |\n" }}
    {{ $content = $content | replaceRE `§TH§([^§]*)§/TH§` "$1 |" }}
    {{ $content = $content | replaceRE `§TD§([^§]*)§/TD§` "$1 |" }}

    {{/* Add header separator after first row */}}
    {{ $content = $content | replaceRE `(\|[^|\n]*\|)\n§HEADER_SEPARATOR§` "$1\n| --- | --- | --- | --- | --- |\n" }}
    {{ $content = $content | replaceRE `§HEADER_SEPARATOR§` "" }}

    {{/* Clean up extra separators and fix table formatting */}}
    {{ $content = $content | replaceRE `\|\s+\|` "| |" }}
    {{ $content = $content | replaceRE `\|\s*$` "|" }}
  {{ end }}

  {{/* Step 9: Handle blockquotes */}}
  {{ if findRE `<blockquote\b` $content 1 }}
    {{ $content = $content | replaceRE `(?is)§QUOTE_START§<blockquote[^>]*?>(.*?)</blockquote>§QUOTE_END§` "\n\n> $1\n\n" }}
  {{ end }}

  {{/* Step 10: Handle lists with enhanced spacing and nesting support */}}
  {{ if findRE `<[uo]l\b` $content 1 }}
    {{/* Process list markers */}}
    {{ $content = $content | replaceRE `(?is)§LIST_START§<ul[^>]*?>(.*?)</ul>§LIST_END§` "\n\n§UL§$1§/UL§\n\n" }}
    {{ $content = $content | replaceRE `(?is)§LIST_START§<ol[^>]*?>(.*?)</ol>§LIST_END§` "\n\n§OL§$1§/OL§\n\n" }}

    {{/* Handle nested lists */}}
    {{ $content = $content | replaceRE `(?is)<ul[^>]*?>(.*?)</ul>` "§UL_NESTED§$1§/UL_NESTED§" }}
    {{ $content = $content | replaceRE `(?is)<ol[^>]*?>(.*?)</ol>` "§OL_NESTED§$1§/OL_NESTED§" }}

    {{/* Process list items */}}
    {{ $content = $content | replaceRE `(?is)<li[^>]*?>(.*?)</li>` "§LI§$1§/LI§\n" }}

    {{/* Convert to markdown format */}}
    {{ $content = $content | replaceRE `(?s)§UL§(.*?)§/UL§` "$1" }}
    {{ $content = $content | replaceRE `(?s)§OL§(.*?)§/OL§` "$1" }}
    {{ $content = $content | replaceRE `(?s)§UL_NESTED§(.*?)§/UL_NESTED§` "\n$1" }}
    {{ $content = $content | replaceRE `(?s)§OL_NESTED§(.*?)§/OL_NESTED§` "\n$1" }}

    {{/* Convert list items to markdown */}}
    {{ $content = $content | replaceRE `§LI§([^§]*)§/LI§` "- $1\n" }}

    {{/* Clean up list formatting */}}
    {{ $content = $content | replaceRE `- \n` "- \n" }}
  {{ end }}

  {{/* Step 11: Handle emphasis and strong formatting */}}
  {{ if or (findRE `<(?:strong|b)\b` $content 1) (findRE `<(?:em|i)\b` $content 1) }}
    {{ $content = $content | replaceRE `(?is)<strong[^>]*?>(.*?)</strong>` "**$1**" }}
    {{ $content = $content | replaceRE `(?is)<b[^>]*?>(.*?)</b>` "**$1**" }}
    {{ $content = $content | replaceRE `(?is)<em[^>]*?>(.*?)</em>` "*$1*" }}
    {{ $content = $content | replaceRE `(?is)<i[^>]*?>(.*?)</i>` "*$1*" }}
  {{ end }}

  {{/* Step 12: Handle divs and other containers */}}
  {{ $content = $content | replaceRE `(?is)<div[^>]*?>(.*?)</div>` "$1" }}
  {{ $content = $content | replaceRE `(?is)<span[^>]*?>(.*?)</span>` "$1" }}

{{ end }}

{{/* Use Hugo's built-in plainify to handle remaining HTML and entities */}}
{{ $content = $content | plainify }}

{{/* Enhanced whitespace cleanup - preserve readability while removing excess */}}
{{ $content = $content | replaceRE `\n{4,}` "\n\n\n" }}      {{/* Limit max consecutive newlines to 3 */}}
{{ $content = $content | replaceRE `[ \t]+\n` "\n" }}        {{/* Remove trailing spaces */}}
{{ $content = $content | replaceRE `\n[ \t]+` "\n" }}        {{/* Remove leading spaces on new lines */}}
{{ $content = $content | replaceRE `^\s+` "" }}              {{/* Remove leading whitespace from start */}}
{{ $content = $content | replaceRE `\s+$` "" }}              {{/* Remove trailing whitespace from end */}}

{{/* Fix specific spacing issues */}}
{{ $content = $content | replaceRE `\n\n\n+` "\n\n" }}       {{/* Normalize double spacing after cleanup */}}
{{ $content = $content | replaceRE `([.!?])\n([A-Z])` "$1\n\n$2" }} {{/* Add spacing between sentences and new paragraphs */}}

{{/* Fix table formatting issues */}}
{{ $content = $content | replaceRE `\|\s*\n\s*\|` "|\n|" }}  {{/* Clean up table row breaks */}}
{{ $content = $content | replaceRE `\|\s+([^|\n]*?)\s+\|` "| $1 |" }} {{/* Normalize table cell spacing */}}

{{/* Clean up any remaining markers */}}
{{ $content = $content | replaceRE `§[^§]*§` "" }}

{{/* Return the processed content */}}
{{ return $content }}
