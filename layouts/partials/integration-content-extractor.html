{{- $int_name := .int_name -}}
{{- $section := .section -}}  {{- /* "Metrics" or "Service Checks" */ -}}
{{- $context := .context -}}

{{- /* Build integration pages lookup once per site build */ -}}
{{- $integrationPages := $context.Page.Scratch.Get "integration_pages_map" -}}
{{- if not $integrationPages -}}
  {{- $integrationPages = dict -}}
  {{- range where $context.Site.AllPages "Section" "integrations" -}}
    {{- if eq .Language.Lang "en" -}}
      {{- $integrationPages = merge $integrationPages (dict .File.BaseFileName .) -}}
    {{- end -}}
  {{- end -}}
  {{- $context.Page.Scratch.Set "integration_pages_map" $integrationPages -}}
{{- end -}}

{{- $page := index $integrationPages $int_name -}}

{{- if not $page -}}
  {{- if eq hugo.Environment "development" -}}
    {{ warnf "Integration page for '%s' not found." $int_name }}
  {{- end -}}
{{- else -}}
  {{- $pattern := printf `(?s)### %s\n(.*?)(#{2,3}\s)` $section -}}
  {{- $matches := findRE $pattern $page.RawContent 1 -}}
  {{- if not $matches -}}
    {{- if eq hugo.Environment "development" -}}
      {{ warnf "No ### %s section found in '%s' integration documentation." $section $int_name }}
    {{- end -}}
  {{- else -}}
    {{- range $matches -}}
      {{- $content := strings.TrimPrefix (printf "### %s\n" $section) . | strings.TrimSuffix (index (findRE "(#{2,3}\\s)$" . 1) 0) -}}
      {{- $content = replaceRE `\{\{<[^>]+>\}\}` "" $content -}}
      {{- $content | markdownify -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
