{{- $int_name := .int_name -}}
{{- $section := .section -}}  {{- /* "Metrics" or "Service Checks" */ -}}
{{- $context := .context -}}

{{- /* Build integration pages lookup once per site build */ -}}
{{- $storeKey := "integration_pages_map" -}}
{{- $integrationPages := dict -}}

{{- /* Try to get from store first, fallback to building fresh */ -}}
{{- if isset $context.Site.Data "integration_pages_cache" -}}
  {{- $integrationPages = $context.Site.Data.integration_pages_cache -}}
{{- else -}}
  {{- range where $context.Site.AllPages "Section" "integrations" -}}
    {{- if eq .Language.Lang "en" -}}
      {{- $integrationPages = merge $integrationPages (dict .File.BaseFileName .) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $page := index $integrationPages $int_name -}}

{{- if not $page -}}
  {{- if eq hugo.Environment "development" -}}
    {{ warnf "Integration page for '%s' not found." $int_name }}
  {{- end -}}
  {{- return "" -}}
{{- end -}}

{{- $pattern := printf `(?s)### %s\n(.*?)(#{2,3}\s)` $section -}}
{{- $matches := findRE $pattern $page.RawContent 1 -}}
{{- if not $matches -}}
  {{- if eq hugo.Environment "development" -}}
    {{ warnf "No ### %s section found in '%s' integration documentation." $section $int_name }}
  {{- end -}}
  {{- return "" -}}
{{- end -}}

{{- range $matches -}}
  {{- $content := strings.TrimPrefix (printf "### %s\n" $section) . | strings.TrimSuffix (index (findRE "(#{2,3}\\s)$" . 1) 0) -}}
  {{- $content = replaceRE `\{\{<[^>]+>\}\}` "" $content -}}
  {{- return ($content | markdownify) -}}
{{- end -}}
