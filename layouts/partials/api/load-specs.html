{{- /* layouts/partials/api/load-specs.html
     Loads the prebuilt compact OpenAPI view produced by Option A:
       assets/api/<version>/view.json
     Returns a map:
       {
         "version": <string>,
         "path": <string>,
         "view": <entire JSON>,
         "schemas": <map[string]schema>,
         "parameters": <map[string]param>,
         "requestBodies": <map[string]rb>,
         "headers": <map[string]header>
       }
     Usage:
       {{ $api := partial "api/load-specs.html" (dict "version" "v1") }}
       {{ with $api.schemas.Widget }} ... {{ end }}
*/ -}}

{{- $ver  := .version | default "v1" -}}
{{- $path := printf "/api/%s/view.json" $ver -}}
{{- $res  := resources.Get $path -}}

{{- if not $res -}}
  {{- errorf "OpenAPI(view): version=%q resource %q not found. Did you generate it? (node assets/scripts/build-oas-view.mjs assets/api/%s/full_spec.yaml assets/api/%s/view.json)" $ver $path $ver $ver -}}
{{- end -}}

{{- $view := $res | transform.Unmarshal -}}

{{- if not (index $view "x-hugo-preprocessed") -}}
  {{- warnf "OpenAPI(view): %q missing x-hugo-preprocessed=true; proceeding anyway." $path -}}
{{- end -}}

{{- $schemas       := index $view "schemas" | default dict -}}
{{- $parameters    := index $view "parameters" | default dict -}}
{{- $requestBodies := index $view "requestBodies" | default dict -}}
{{- $headers       := index $view "headers" | default dict -}}

{{- return (dict
  "version"       $ver
  "path"          $path
  "view"          $view
  "schemas"       $schemas
  "parameters"    $parameters
  "requestBodies" $requestBodies
  "headers"       $headers
  "tags"          (slice)
) -}}
