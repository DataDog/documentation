{{- $securitySchemes := .securitySchemes -}}
{{- $pathParams := .dollarScratch.Get "pathParams" -}}
{{- $queryStrings := .dollarScratch.Get "queryStrings" -}}
{{- $count := 0 -}}

{{- with $pathParams -}}
    <span class="c1"># Path parameters</span><br/>
    {{- range . -}}
        <span class="kn">export</span> <span class="n">{{ .name }}</span><span class="o">=</span><span class="s1">"{{ .example | default (.schema.example | default "CHANGE_ME") }}"</span><br/>
    {{- end -}}
{{- end -}}

{{- with $queryStrings -}}
    {{- $i := 0 -}}
    {{- range . -}}
        {{- if eq .required true -}}
            {{- if eq $i 0 -}}
                <span class="c1"># Required query arguments</span><br/>
            {{- end -}}
            <span class="kn">export</span> <span class="n">{{ .name }}</span><span class="o">=</span><span class="s1">"{{ .example | default (.schema.example | default "CHANGE_ME") }}"</span><br/>
            {{- $i = add $count 1 -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- if isset .exampleDefinition "x-variables" -}}
    {{- with index .exampleDefinition "x-variables" -}}
        <span class="c1"># Template variables</span><br/>
        {{- range $name, $example := . -}}
            <span class="kn">export</span> <span class="n">{{ $name }}</span><span class="o">=</span><span class="s1">"{{ $example }}"</span><br/>
        {{- end -}}
    {{- end -}}
{{- end -}}

<span class="c1"># Curl command</span>
<span class="n">curl</span> <span class="o">-X</span> <span class="s1 text-uppercase">{{ .context.actionType }}</span> {{ range .dollarScratch.Get "serverURLS" }}{{ if ne .region "local" }}<span class="kn d-none" data-region="{{ .region }}">{{ .url }}</span>{{ else }}<span class="kn">{{ .url }}</span>{{ end }}{{ end }}<span class="n">{{ replace .context.pathKey "{" "${" }}</span>
{{- range $qi, $q := $queryStrings -}}
    {{- if eq .required true -}}
        <span class="o">{{ cond (gt $qi 1) "&" "?" }}</span><span class="n">{{ $q.name }}</span><span class="o">=</span><span class="s1">${ {{- $q.name -}} }</span>
    {{- end -}}
{{- end -}}

{{- /* Render authentication query parameters "?api_key=XXX" */ -}}
{{- with .context.action.security -}}
    {{- $i := 0 -}}
    {{- range . -}}
        {{- range $key, $val := . -}}
            {{ $authSchema := (index $securitySchemes $key) }}
            {{- if eq $authSchema.in "query" -}}
                <span class="o">{{- if eq $i 0 -}}?{{- else -}}&{{- end -}}</span><span class="n">{{ $authSchema.name }}</span><span class="o">=</span><span class="n">${ {{- index $authSchema "x-env-name" -}} }</span>
                {{- $i = add $count 1 -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- /* Content-Type header based on "requestBody" */ -}}
&nbsp;\
<span class="o">-H</span> <span class="s1">"Content-Type: {{ default "application/json" .contentType }}"</span>

{{- /* Render authentication in headers "DD-API-KEY: XXX" */ -}}
{{- if isset .context.action "security" -}}
    {{- /* Find authentication per operationId */ -}}
    {{- range .context.action.security -}}
        {{- range $key, $val := . -}}
            {{ $authSchema := (index $securitySchemes $key) }}
            {{- if eq $authSchema.in "header" -}}
                &nbsp;\
<span class="o">-H</span> <span class="s1">"{{ $authSchema.name }}: <span class="n">${ {{- index $authSchema "x-env-name" -}} }</span>"</span>
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- else -}}
    {{- /* Use global authentication */ -}}
    &nbsp;\
<span class="o">-H</span> <span class="s1">"{{ $securitySchemes.apiKeyAuth.name }}: <span class="n">${ {{- index $securitySchemes.apiKeyAuth "x-env-name" -}} }</span>"</span> \
<span class="o">-H</span> <span class="s1">"{{ $securitySchemes.appKeyAuth.name }}: <span class="n">${ {{- index $securitySchemes.appKeyAuth "x-env-name" -}} }</span>"</span>
{{- end -}}

{{- /* Render requestBody example JSON "-d @- << EOF ... EOF" */ -}}
{{- if .context.action.requestBody -}}
&nbsp;\
<span class="o">-d</span> <span class="n">@-</span> <span class="o"><<</span> <span class="n">EOF</span>
<span class="s1">{{ .exampleValue | default (.dollarScratch.Get "jsonRequestBody") }}</span>
<span class="n">EOF</span>
{{- end -}}
<br/>
