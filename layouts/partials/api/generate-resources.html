{{/* Generate all API resources at build time */}}
{{ $context := .context }}
{{ $version := .version }}
{{ $apiData := index $context.Site.Data.api $version }}
{{ $codeExampleLookup := $apiData.CodeExamples }}

{{/* Template for code examples */}}
{{ $codeExampleTemplate := `
<h3 class="mb-2">{{ i18n "code_example" }}</h3>
<div class="programming-lang-wrapper js-code-snippet-wrapper">
  {{ range .examples }}
    <div class="code-snippet-wrapper js-code-block" data-code-lang-block="{{ .lang }}">
      <div class="code-snippet">
        <div class="highlight">
          <div class="example-accordion" id="accordion-{{ .operationid }}-{{ .version }}-{{ .lang }}">
            {{ range $i, $item := .items }}
              <div class="card">
                <div class="card-header p-0">
                  <h5 class="m-0">
                    <button class="btn btn-link {{if gt $i 0}}collapsed{{end}}"
                            data-bs-toggle="collapse"
                            data-bs-target="#{{ $.operationid }}-{{ $.version }}-example-{{ $i }}"
                            aria-expanded="{{if eq $i 0}}true{{else}}false{{end}}">
                      {{ $item.description }}
                    </button>
                  </h5>
                </div>
                <div id="{{ $.operationid }}-{{ $.version }}-example-{{ $i }}"
                     class="collapse {{if eq $i 0}}show{{end}}"
                     data-bs-parent="#accordion-{{ $.operationid }}-{{ $.version }}-{{ $.lang }}">
                  <div class="card-body p-0 code-snippet">
                    <div class="code-button-wrapper position-absolute">
                      <button class="btn text-primary js-copy-button">{{ $.copyText }}</button>
                    </div>
                    <pre class="chroma">
                      <code class="language-fallback" data-lang="fallback">{{ $item.code }}</code>
                    </pre>
                  </div>
                </div>
              </div>
            {{ end }}
          </div>
        </div>
      </div>
    </div>
  {{ end }}
</div>
` }}

{{/* Generate resources for each operation */}}
{{ range $operationId, $examples := $codeExampleLookup }}
  {{ $processedExamples := slice }}

  {{/* Process curl examples */}}
  {{ $curlItems := slice }}
  {{ range $i, $item := $examples }}
    {{ $curlCode := partial "api/curl.html" (dict
      "context" $context
      "endpoint" (dict "action" (dict "operationId" $operationId "summary" $item.description))
      "title" $item.description
    ) }}
    {{ $curlItems = $curlItems | append (dict "description" $item.description "code" $curlCode) }}
  {{ end }}

  {{ if $curlItems }}
    {{ $curlExample := dict
      "lang" "curl"
      "operationid" $operationId
      "version" $version
      "items" $curlItems
      "copyText" (i18n "copy")
    }}
    {{ $processedExamples = $processedExamples | append $curlExample }}
  {{ end }}

  {{/* Process other language examples */}}
  {{ range $langExt, $langConfig := $context.Site.Params.code_languages }}
    {{ $langItems := slice }}
    {{ range $i, $item := $examples }}
      {{ $fileName := printf "%s%s.%s" $operationId $item.suffix $langExt }}
      {{ $resource := $context.Site.GetPage "section" "api" | .Resources.GetMatch $fileName }}
      {{ if $resource }}
        {{ $langItems = $langItems | append (dict "description" $item.description "code" $resource.Content) }}
      {{ end }}
    {{ end }}

    {{ if $langItems }}
      {{ $langExample := dict
        "lang" $langConfig.name
        "operationid" $operationId
        "version" $version
        "items" $langItems
        "copyText" (i18n "copy")
      }}
      {{ $processedExamples = $processedExamples | append $langExample }}
    {{ end }}
  {{ end }}

  {{/* Generate the resource */}}
  {{ if $processedExamples }}
    {{ $resourceData := dict "examples" $processedExamples }}
    {{ $resource := resources.FromString (printf "templates/code-example-%s.html" $operationId) $codeExampleTemplate }}
    {{ $processed := $resource | resources.ExecuteAsTemplate (printf "api-code-examples/%s.html" $operationId) $resourceData }}

    {{/* Cache the resource reference */}}
    {{ $context.Scratch.Set (printf "code-example-%s" $operationId) $processed.RelPermalink }}
  {{ end }}
{{ end }}
