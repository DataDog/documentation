{{ $serverMode := site.IsServer }}
{{ $jsMain     := "js/main.js" }}
{{ $defines    := dict "CI_COMMIT_SHORT_SHA" (getenv "CI_COMMIT_SHORT_SHA" | default `""`) "process.env.RESET_APP_DATA_TIMER" `""` "process.env.NODE_ENV" `""` }}
{{ $devOpts    := dict "defines" $defines "targetPath" "js/app.js" "sourceMap" "inline" }}
{{ $prodOpts   := dict "defines" $defines "targetPath" "js/app.js" "minify" true }}
{{/* Activate dev mode only when running `hugo server` */}}
{{ $jsOpts     := cond $serverMode $devOpts $prodOpts }}
{{ $js         := resources.Get $jsMain | js.Build $jsOpts | babel }}

{{/* Hugo Pipes struggles with jQuery, so let's just import it first */}}
<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

{{ if $serverMode }}
<script type="text/javascript" src="{{ $js.RelPermalink }}" defer></script>
{{ else }}
{{/* For prod mode, add a SHA fingerprint */}}
{{ $prodJs := $js | resources.Fingerprint "sha512" }}
<script type="text/javascript" src="{{ $prodJs.Permalink }}" integrity="{{ $prodJs.Data.Integrity }}" defer></script>
{{ end }}
