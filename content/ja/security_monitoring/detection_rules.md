---
title: 脅威検知ルール
kind: ドキュメント
further_reading:
  - link: /security_monitoring/explorer/
    tag: ドキュメント
    text: セキュリティシグナルエクスプローラー
---
## 概要

検出ルールは、取り込んだすべてのログに適用される条件付きロジックを定義します。対象期間内において、検出ルールで定義された少なくとも 1 つのケースが一致した場合に Datadog でセキュリティシグナルが生成されます。Datadog は、環境の脅威をすばやく検出する [デフォルトの規則][1]を採用しています。

## 検出ルールを作成する

Datadog で検出ルールを新規作成するには、メインナビゲーションで **Security** → **Detection Rules** --> **New Rule** の順に移動します。

### 検索クエリを定義する

{{< img src="security_platform/security_monitoring/detection_rules/define_search_query.png" alt="検索クエリを定義" >}}

同じロジックを使用して、[ログエクスプローラー検索][2]で検索クエリを構築します。各クエリには ASCII の小文字でラベルが付与されます。クエリ名を ASCII 文字から変更する場合は、鉛筆アイコンをクリックします。

オプションとして、シグナルのグループを定義することもできます。定義されたグループに応じて、各グループの値に対するシグナルが生成されます。通常、グループ化する値にはエンティティ (ユーザー、IP など) が用いられます。また、グループ化を使って[クエリを結合](#クエリを結合する)することもできます。

別のクエリを追加する場合は Add Query ボタンをクリックします。

**注**: このクエリはすべての Datadog イベントと、インデックス作成を必要としない取り込み済みログに適用されます。



### ルールのケースを定義する

{{< img src="security_platform/security_monitoring/detection_rules/define_rule_case.png" alt="ルールケースを設定" >}}

#### ルールケースのトリガーと名称

`a > 3` などのルールケースは、ステートメントとして評価されます。そのため、シグナルは一致した最初のケースに応じて生成されます。順番を変更する場合は、ルールケースをクリックしたままドラッグします。

ルールケースには、過去に定義されたクエリのイベント数に基づいてシグナルを生成すべきかを判断するための論理演算 (`>、>=、&&、||`) が含まれます。ここで ASCII 小文字の [クエリラベル](#検索クエリを定義する) が参照されます。

**注**: クエリラベルは演算子に先行しなければなりません。たとえば、`a < 3` は使用できますが、 `3 > a` は許容されません。

各ルールケースにつき、「ケース 1」のような**名前**を付与します。シグナルの生成時には、この名前がルールの名称に追加されます。

#### 重大度および通知

セキュリティシグナルの重大度を設定します。ドロップダウンから適切な重大度レベル (`INFO`、`LOW`、`MEDIUM`、`HIGH`、`CRITICAL`) を選択してください。

“Notify” セクションで、各ルールケースに対する [通知ターゲット][3]  (0 以上) を構成します。

#### タイムウィンドウ

`evaluation window` は少なくとも 1 つのケースが一致した場合に指定されるスライド式のウィンドウで、リアルタイムで評価が行われます。

シグナルが生成された後、この `keep alive` ウィンドウ内でケースが少なくとも 1 回一致した場合、そのシグナルは「オープン」状態として残ります。新しいイベントがケースのいずれかと一致する度に、シグナルの*最終更新日付*タイムスタンプが更新されます。

`maximum signal duration` に達すると、シグナルはクエリと一致したかどうかに関わらず「クローズ」されます。この時間は最初に記録されたタイムスタンプに基づいて計算します。

その他のケースを追加する場合は **Add Case** ボタンをクリックします。

**注**: この `evaluation window` は、`keep alive` および `maximum signal duration` 以下でなければなりません。

### セキュリティシグナルメッセージ

通知ボックスは[モニター通知][4]と同じマークダウンとプレビュー機能を備えています。

**ルール名**セクションで、ルールリストビューに表示されるルール名や、セキュリティシグナルのタイトルを構成することができます。

`security:attack` や `technique:T1110-brute-force` など、シグナル固有のタグを付加しましょう。

**注**: `security` タグはセキュリティシグナルの分類に用いられる特殊なタグです。`attack`、`threat-intel`、`compliance`、`anomaly`、`data-leak` など他のタグの使用を推奨します。

### クエリを結合する

タイムフレームをまたぐログを結合すると、セキュリティシグナルの信頼性と重大度を強化することができます。たとえば、ブルートフォースアタックを検出するためには、成功した場合と失敗した場合の認証ログをユーザーと関連付ける必要があります。

{{< img src="security_platform/security_monitoring/detection_rules/joining_queries_define.png" alt="検索クエリを定義"  >}}

検出ルールはグループ化の値をもとにログを結合します。グループ化の値は通常エンティティ (IP アドレス、ユーザーなど) となりますが、必要に応じてすべての属性を使用できます。

{{< img src="security_platform/security_monitoring/detection_rules/group_by.png" alt="グループ化"  >}}

検出ルールケースは、グループ化の値に基づいてこれらのクエリを結合します。一致するケースと値が同じでなければならないため、グループ化属性には通常同じ属性が設定されます。グループ化の値が存在しない場合、ケースが一致することはありません。セキュリティシグナルはケースが一致した場合のみ、一意のグループ化値に対して生成されます。

{{< img src="security_platform/security_monitoring/detection_rules/set_rule_cases2.png" alt="ルールケースを設定"  >}}

以下の例は、同じ `@usr.name` で5 回を超えてログインに失敗した場合、および 1 回ログインに成功した場合のケースです。この場合、最初のケースに一致した場合はセキュリティシグナルが生成されます。

{{< img src="security_platform/security_monitoring/detection_rules/gbv2.png" alt="ルールケースを設定" >}}

## 検出ルールを管理する

すべての検出ルールは[セキュリティコンフィギュレーション検出ルール][5]ページから検索が可能です。これらのルールを活用して、生成したシグナルの有効化、無効化、編集、削除、複製、表示などをすばやく行うことができます。また、ビューから[新規ルール][6]を作成することもできます。

### ルールの検索

フリーテキスト検索を使うと、ルール名やクエリに含まれるテキストで検出ルールを絞り込むことができます。クエリが編集された場合、“Search” ボタンを再度クリックしなくてもクエリ結果がリアルタイムで更新されます。

### 検出ルールテーブル

{{< img src="security_platform/security_monitoring/detection_rules/rules_table2.png" alt="検出ルールテーブル"  >}}

検出ルールは検出ルールテーブルに表示されます。

Options ボタンを使用して、検出ルールテーブルの内容をニーズに応じて構成します。追加できる列は作成日とルール ID のみです。

デフォルトの場合、検出ルールはアルファベットの昇順 (A-Z) でソートされます。名前で逆ソートしたり、クエリ名、作成日、ルール ID で並び替えたりすることも可能です。

#### ルールの有効化 / 無効化

ルールの右側にあるトグルスイッチを使ってルールを有効または無効にすることができます。

#### ルールの編集

ルールの上にカーソルを重ねて、**Edit** ボタンをクリックするとルールを編集できます。

#### ルールごとに生成されたシグナルを検索

ルールの上にカーソルを重ねて **View Generated Signals** ボタンをクリックすると、そのルールで生成されたシグナルを検索できます。

#### ルールの複製

ルールの上にカーソルを重ねて、**Clone** ボタンをクリックするとルールを複製できます。

#### ルールの削除

ルールの上にカーソルを重ねて、**Delete** ボタンをクリックするとルールを削除できます。

## その他の参考資料
{{< partial name="whats-next/whats-next.html" >}}



[1]: /ja/security_monitoring/default_rules/
[2]: /ja/logs/explorer/search/
[3]: /ja/monitors/notifications/?tab=is_alert#integrations
[4]: /ja/monitors/notifications/
[5]: https://app.datadoghq.com/security/configuration/rules
[6]: https://app.datadoghq.com/security/configuration/rules/new
