---
description: モニター作成ページについて説明します。
kind: documentation
title: モニターの構成
---

## 概要

[モニタータイプ][1]を選択したら、モニターの構成を開始します。
モニターを保存する前に、次の 4 つの主要手順を完了する必要があります。

* **検索クエリを定義します。**イベントのカウント、メトリクスの測定、1 つまたは複数のディメンションによるグループ化などを行うクエリを作成します。
* **アラート条件を設定します。**アラートと警告のしきい値、評価タイムフレームを定義し、高度なアラートオプションを構成します。
* **何が起こっているかを伝えます。**変数を使用してカスタム通知のタイトルとメッセージを記述します。
* **チームに通知します。**通知をチームに送信する方法を選択します (メール、Slack、PagerDuty など)

## 検索クエリを定義する

検索クエリの作成方法については、個々の[モニタータイプ][1]ページを参照してください。検索クエリを定義すると、検索フィールドの上のプレビューグラフが更新されます。

{{< img src="/monitors/create/preview_graph_monitor.mp4" alt="プレビューグラフ" video=true style="width:90%;">}}

### アラートのグループ化

アラートは、クエリを定義する際に `group by` の手順で選択したグループに応じて自動的にグループ化されます。グループを設定していない場合は、デフォルトで `Simple Alert` (シンプルアラート) でグループ化されます。クエリがディメンションでグループ化されている場合は、デフォルトで `Multi Alert` (マルチアラート) でグループ化されます。

`Simple Alert` モードでは、すべての報告元ソースを集計します。集計値が設定条件を満たすと、**アラートを 1 件**受信します。

グループパラメーターに従い、`Multi Alert` モードが各ソースに適用されます。各グループで設定された条件を満たすと、アラートが送信されます。たとえば、容量メトリクスを調べるクエリを `host` および `device` でグループ化すると、容量不足のデバイスに対してアラートを個別に送信できます。
メトリクスが `device` タグを伴わない `host` のみで報告する場合、モニターグループにより `host` と `device` の両方で検出されません。複数アラートで評価される各グループには[タグ変数][4]を利用でき、便利なコンテキストで通知を動的に入力します。

| グループ化                       | シンプルアラートモード | マルチアラートモード |
|-------------------------------------|------------------------|-----------------------|
| _(すべて)_                      | 1 つの通知をトリガーする 1 つの単一グループ | N/A |
| 1 つ以上のディメンション | 1 つ以上のグループがアラート条件を満たす場合の 1 つの通知 | アラート条件を満たすグループごとに 1 つの通知 |

## アラートの条件を設定する

アラート条件は、[モニタータイプ][1]によって異なります。クエリ値がしきい値を超えた場合、または特定の数の連続したチェックが失敗した場合にトリガーするようにモニターを構成します。

{{< tabs >}}
{{% tab "しきい値アラート" %}}

* メトリクスが `above`、`above or equal to`、`below`、`below or equal to` の場合にトリガーされる
* しきい値は、`on average`、`at least once`、`at all times` あるいは `in total`
* 過去 `5 minutes`、`15 minutes`、`1 hour` など、または `custom` に 1 分～48 時間 (メトリクスモニターに対して 1 か月) の値を設定します。

### 集計の方法

クエリは一連のポイントを返しますが、しきい値と比較するには単一の値が必要です。モニターは、評価ウィンドウのデータを単一の値に減らす必要があります。

| オプション                  | 説明                                            |
|-------------------------|--------------------------------------------------------|
| on&nbsp;average         | 系列の平均値が算出され、単一の値が生成されます。この値がしきい値と比較されます。このオプションは、モニタークエリに `avg()` 関数を追加します。 |
| at&nbsp;least&nbsp;once | 生成された系列内の値がいずれか 1 つでもしきい値から外れている場合に、アラートがトリガーされます。このオプションは、比較方法の選択に基づいて、モニタークエリに関数を追加します。below を選択した場合は `min()`、above を選択した場合は `max()` が追加されます。 |
| at&nbsp;all&nbsp;times  | クエリの評価ウィンドウ内のすべてのポイントがしきい値から外れている場合に、アラートがトリガーされます。このオプションは、比較方法の選択に基づいて、モニタークエリに関数を追加します。above を選択した場合は `min()`、below を選択した場合は `max()` が追加されます。 |
| in&nbsp;total           | 系列内のすべてのポイントの合計値がしきい値から外れている場合に、アラートがトリガーされます。このオプションは、モニタークエリに `sum()` 関数を追加します。 |

**注**: `as_count()` を使用する場合は動作が異なります。詳しくは、[モニター評価での as_count()][1] を参照してください。

### 評価ウィンドウ

モニターは、過去 `5 minutes`、`15 minutes`、`1 hour` などを振り返って、特定の頻度で評価されます。

### 評価頻度

評価頻度は、Datadog がモニタークエリを実行する頻度を定義します。ほとんどの構成では、評価頻度は `1 minute` で、これは 1 分ごとにモニターが[選択したデータ](#define-the-search-query)を[選択した評価ウィンドウ](#evaluation-window)にクエリして、[定義したしきい値](#thresholds)と集計値を比較することを意味します。

### しきい値

しきい値には、アラートをトリガーする数値を設定します。メトリクスに何を選ぶかによって、エディターに表示される単位 (`byte`、`kibibyte`、`gibibyte` など) が変わります。

Datadog には、アラートと警告の 2 種類の通知があります。モニターのリカバリはアラートや警告のしきい値に基づいて自動的に行われますが、条件を追加することもできます。リカバリのしきい値について詳しくは、[リカバリのしきい値とは][2]を参照してください。たとえば、メトリクスが `3` を超えたときにモニターがアラートを出し、回復しきい値が指定されていない場合、メトリクス値が `3` を下回るとモニターは回復します。

| オプション                                   | 説明                    |
|------------------------------------------|--------------------------------|
| アラートしきい値 **(必須)** | アラートの通知のトリガーに使用される値 |
| 警告しきい値                   | 警告の通知のトリガーに使用される値 |
| アラート回復しきい値       | アラートのリカバリに対する追加条件を示すしきい値 (任意) |
| 警告回復しきい値     | 警告のリカバリに対する追加条件を示すしきい値 (任意) |

しきい値を変更すると、エディター内でプレビューグラフにカットオフポイントを示すマーカーが表示されます。

{{< img src="/monitors/create/preview_graph_thresholds.png" alt="しきい値プレビューグラフ" style="width:100%;">}}

**メモ**: しきい値を小数で入力する際、値が `<1` の場合は先頭に `0` を付けます。たとえば、`.5` ではなく `0.5` としてください。


[1]: /ja/monitors/guide/as-count-in-monitor-evaluations/
[2]: /ja/monitors/guide/recovery-thresholds/
{{% /tab %}}
{{% tab "チェックアラート" %}}

チェックアラートは、各チェックグループにつき、送信されたステータスを連続的にトラックし、しきい値と比較します。チェックアラートを次のように設定します。

1. 何回連続して失敗したらアラートをトリガーするか、回数 `<数値>` を選択します。

    各チェックは `OK`、`WARN`、`CRITICAL` のいずれか 1 つのステータスを送信します。`WARN` と `CRITICAL` ステータスが連続して何回送信されたら通知をトリガーするか選択します。たとえば、プロセスで接続に失敗する異常が 1 回発生したとします。値を `> 1` に設定した場合、この異常は無視されますが、2 回以上連続で失敗した場合は通知をトリガーします。

    {{< img src="/monitors/create/check_thresholds_alert_warn.png" alt="しきい値アラート/警告のチェック" style="width:90%;">}}

2. 何回連続して成功したらアラートを解決するか、回数 `<数値>` を選択します。

    何回連続して `OK` ステータスが送信されたらアラートを解決するか、回数を選択します。

    {{< img src="/monitors/create/check_thresholds_recovery.png" alt="しきい値回復のチェック" style="width:90%;">}}

チェックアラートの構成の詳細については、[プロセスチェック][1]、[インテグレーションチェック][2]、[カスタムチェック][3]モニターのドキュメントを参照してください。



[1]: /ja/monitors/create/types/process_check/
[2]: /ja/monitors/create/types/integration/?tab=checkalert#integration-status
[3]: /ja/monitors/create/types/custom_check/
{{% /tab %}}
{{< /tabs >}}

### 高度なアラート条件

#### No Data

正常な状態で、メトリクスが常にデータを報告するようにするには、「データなし」通知を利用すると便利です。たとえば、Agent を使用しているホストが継続的に稼働している必要がある場合、`system.cpu.idle` メトリクスがデータを常に報告することが期待されます。

この場合、データ欠落の通知を有効にする必要があります。以下のセクションでは、各オプションでこれを実現する方法を説明します。

データ欠落への対応には 2 つの方法があります。
- 制限付きの `Notify no data` オプションを使用したメトリクスベースのモニター
- `On missing data` オプションは、APM Trace Analytics、Audit Log、CI Pipelines、Error Tracking、Events、Logs、および RUM モニターでサポートされています

{{< tabs >}}
{{% tab "メトリクスベースのモニター" %}}

データなしを通知しない場合は `Do not notify` を、データなしが `N` 分以上続いた時に通知する場合は `Notify` を設定します。

データが欠落している場合、またはデータが欠落していない場合に通知されます。構成された時間帯にデータが受信されなかった場合に通知されます。

**注**: 「データなし」ウィンドウは、評価期間中に最低 2 回設定することを推奨します。

自動的に停止・起動するホストのオートスケーリンググループのメトリクスを監視している場合、データがないことを通知すると、多くの通知が発生します。

この場合、欠落データに対する通知を有効にするべきではありません。このオプションは、データが長期間報告されていない時に有効にすると機能しません。

##### グループ化

「データなし」を通知しないモニターの場合、グループがデータを報告しないとモニターは評価をスキップし、最終的にグループをドロップします。この期間、結果ページのバーは緑のままです。データがありグループが報告を再開すると、グリーンバーには OK ステータスとバックフィルが表示され、中断がなかったかのように見せます。

{{% /tab %}}

{{% tab "その他のモニタータイプ" %}}

`N` 分のデータがない場合、ドロップダウンメニューからオプションを選択します。

{{< img src="/monitors/create/on_missing_data.png" alt="データなしオプション" style="width:70%;">}}

- `Evaluate as zero` / `Show last known status`
- `Show NO DATA`
- `Show NO DATA and notify`
- `Show OK`

選択された動作は、モニターのクエリがデータを返さなかったときに適用されます。`Do not notify`オプションとは異なり、データ欠落ウィンドウは**構成できません**。

| オプション                    | モニターステータスと通知                                             |
|---------------------------|---------------------------------------------------------------------------|
| `Evaluate as zero`        | 空の結果はゼロに置き換えられ、アラート/警告のしきい値と比較されます。例えば、警告しきい値が `> 10` に設定されている場合、ゼロはその状態をトリガーせず、モニターのステータスは `OK` に設定されます。   |
| `Show last known status`  | グループまたはモニターの最後の既知のステータスが設定されます。                        |
| `Show NO DATA`            | モニターステータスが `NO DATA` に設定されます。                                       |
| `Show NO DATA and notify` | モニターステータスが `NO DATA` に設定され、通知が送信されます。        |
| `Show OK`                 | モニターは解決され、ステータスは `OK` に設定されます。                            |

`Evaluate as zero` と `Show last known status` のオプションが、クエリの種類に応じて表示されます。

- **Evaluate as zero:** このオプションは `Count` クエリを使用するモニターに使用できます。
- **Show last known status:** このオプションは `Count` 以外のクエリタイプ、例えば `Gauge`、`Rate`、`Distribution` を使用しているモニターで利用できます。

{{% /tab %}}
{{< /tabs >}}

#### Auto resolve

アラートをトリガーされた状態から解決するタイミングを、`[Never]`、`After 1 hour`、`After 2 hours` などで指定します。

自動解決は、データが送信されなくなったときに機能します。データがまだ報告されている場合、モニターは、ALERT または WARN 状態から自動解決されません。データがまだ送信されている場合は、[再通知][3]機能を利用して、問題が解決されていないことをチームに知らせることができます。

メトリクスが定期的に報告を行う場合に、トリガーされたアラートを一定の期間の後に自動で解決したいことがあります。たとえば、エラーのログだけを報告するカウンターがある場合、エラーの数が `0` であれば報告が行われないため、アラートがいつまでも解決しません。このような場合、メトリクスからの報告がないまま一定の期間が経過したらアラートを解決するように設定できます。**注**: モニターがアラートを自動で解決し、次回の評価でクエリーの値がリカバリのしきい値を満たしていない場合、モニターはもう一度アラートをトリガーします。

ほとんどの場合、アラートは問題が実際に修正されてから解決する必要があるため、この設定は不要です。つまり、通常はこれを `[Never]` にしておいて、メトリクスが設定されたしきい値を上回る (または下回る) 場合にだけアラートを解決するようにしてください。

#### グループ保持時間

データが欠落してから `N` 時間経過すると、そのグループをモニターステータスから削除することができます。最大で 72 時間です。

{{< img src="/monitors/create/group_retention_time.png" alt="グループ保持時間オプション" style="width:70%;">}}

[自動解決オプション][4]と同様に、グループの保持は、データが送信されなくなったときに機能します。このオプションは、データが報告されなくなった後、グループがモニターのステータスに保持される時間を制御します。デフォルトでは、グループはドロップされる前に 24 時間ステータスを保持します。グループ保持の開始時間と自動解決オプションは、モニタークエリがデータを返さないとすぐに **同一** になります。

グループ保持時間を定義するユースケースとしては、以下のようなものがあります。

- データが報告されなくなった直後に、グループをドロップしたい場合
- トラブルシューティングのために通常かかる時間と同じだけ、グループのステータスを維持したい場合

**注**: このオプションはマルチアラートモニターでのみ利用可能で、上記の [`On missing data`][5] オプションと連動しています。

#### 新しいグループ遅延

新しいグループの評価開始を `N` 秒遅らせます。

アラートを開始する前に待機する時間 (秒単位)。新しく作成されたグループが起動し、アプリケーションが完全に起動できるようにします。これは負でない整数である必要があります。

たとえば、コンテナ化されたアーキテクチャを使用している場合、グループ遅延を設定すると、新しいコンテナが作成されたときのリソース使用量や待ち時間が長いために、コンテナを対象とするモニターグループがトリガーされなくなります。遅延はすべての新しいグループ (過去 24 時間に表示されていない) に適用され、デフォルトは `60` 秒です。

このオプションは、マルチアラートモードで使用できます。

#### Evaluation Delay

評価を `N` 秒遅らせます。

評価を遅らせる時間 (秒単位)。負以外の整数を指定してください。たとえば、遅延を 900 秒 (15 分) に、モニターが評価を行う期間を直前の `5 minutes` に、時刻を 7:00 に設定すると、モニターは 6:40 から 6:45 までのデータを評価します。

**注**: サービスプロバイダーがバックフィルを行うクラウドメトリクスには、遅延を 15 分に設定することをお勧めします。また、除算の計算式を使用する場合は、モニターが完全な値を評価できるよう、60 秒の遅延を設定すると役に立ちます。


[1]: /ja/monitors/create/#monitor-types
[2]: /ja/monitors/notify/variables/?tab=is_alert#tag-variables
[3]: /ja/monitors/notify/#renotify
[4]: /ja/monitors/create/configuration#auto-resolve
[5]: /ja/monitors/create/configuration/?tabs=othermonitortypes#no-data