---
disable_toc: false
further_reading:
- link: /workflows/actions_catalog
  tag: ドキュメント
  text: アクションカタログで利用可能なアクションを参照する
is_beta: true
kind: documentation
title: ワークフローの構築
---

{{< callout url="https://forms.gle/VEjerYVQ2QJhauZ57" >}}
  Workflows は公開ベータ版です。フィードバックや質問がある場合は、<a href="/help">Datadog サポート</a>にご連絡ください。
{{< /callout >}}

Datadog の [**Workflows** ページ][1]からワークフローを作成したり、既存のワークフローを編集したりすることができます。Workflows ページには、既存のワークフロー、各ワークフローの作成者、各ワークフローの最終修正日および実行日が一覧表示されます。
- ワークフローにカーソルを合わせると、ワークフローの削除や複製を行うことができます。
- 自分が作成したワークフローだけを表示したい場合は、**My workflows** をトグルします。

## ブループリントからワークフローを構築

1. **Blueprints** タブをクリックします。
1. 必要に応じて、検索バーを使用して、名前、カテゴリー、インテグレーションでブループリントのリストを絞り込むことができます。
1. 使用したいブループリントを探し、クリックします。ワークフローキャンバスが表示されます。
1. 鉛筆アイコン (**Edit**) をクリックして、ワークフロー名を更新します。必要であれば、テキストボックスに新しい名前を入力し、**Save** をクリックします。
1. 更新が必要なワークフローステップには、感嘆符のアイコンが表示されます。
1. 変更したいワークフローの各ステップをクリックし、**Configure** タブの空欄に必要事項を入力します。
1. ワークフローの修正が完了したら、**Create From Blueprint** をクリックします。ワークフローキャンバスが更新され、新しく作成されたワークフローが表示されます。

## カスタムワークフローの作成

ワークフローを作成するには
1. **New workflow** をクリックします。
1. ワークフローの名前を入力し、**Create** をクリックします。
1. **Add a step to get started** をクリックし、ワークフローにステップを追加します。また、JSON エディターを使用してワークフローを構築する場合は、**Edit JSON Spec** をクリックします。

### ワークフロービルダーでワークフローを構築する

1. **Add a step to get started** をクリックして、ワークフローに最初のステップを追加します。
1. 検索バーを使ってアクションを検索するか、インテグレーションとその関連アクションをブラウズして、探しているアクションを見つけます。アクションをクリックすると、ワークフローキャンバスのステップに追加されます。
{{< img src="workflows/workflow-builder.mp4" alt="ワークフローキャンバスにステップをドラッグする" video="true"  >}}
1. ワークフローキャンバスでステップをクリックすると、そのステップを構成したり、出力やコンテキスト変数を表示したりすることができます。出力やコンテキスト変数の詳細については、[コンテキスト変数](#context-variables)を参照してください。
1. ステップの構成が完了したら、プラス (`+`) アイコンをクリックして別のステップを追加するか、ワークフローを保存してください。

ワークフロー上のステップをクリックすることで、いつでも編集することができます。ワークフロー上のステップをクリックしてドラッグすると、ステップを並べ替えることができます。

### JSON でワークフローを構築する

ワークフローのページで **Edit JSON Spec** をクリックすると、JSON でワークフローを構築または編集することができます。また、JSON エディターでは、以下のことが可能です。
- **Format JSON**: JSON を美しくします。
- **Export JSON**: ワークフローをダウンロードします。

典型的なワークフローは、3 つのトップレベルのキーを含んでいます。
- `"steps"`: 「step」オブジェクトの配列。各ステップはワークフローのステップを定義し、名前、アクション ID、ステップパラメーターを含みます。また、`steps` オブジェクトには、アウトバウンド接続データのキーが含まれます。
- `"startStepName"`: ワークフローの最初のステップの名前。
- `"connectionEnvs"`: 接続データと環境変数。

ワークフローの例として、`#workflows-test` という名前の Slack チャンネルにメッセージを送信するステップを 1 つだけ持つワークフローを紹介します。

{{< code-block lang="json" collapsible="true" filename="Example workflow" >}}
{
    "steps": [
        {
            "outboundConnections": [],
            "name": "Send_message",
            "actionId": "com.datadoghq.slack.send_simple_message",
            "parameters": [
                {
                    "name": "teamId",
                    "value": "ABC1234"
                },
                {
                    "name": "channel",
                    "value": "#workflows-test"
                },
                {
                    "name": "mentionTargets",
                    "value": [
                        "@Bits"
                    ]
                },
                {
                    "name": "text",
                    "value": "Hello world!"
                }
            ]
        }
    ],
    "startStepName": "Send_message",
    "connectionEnvs": [
        {
            "env": "default",
            "connections": []
        }
    ]
}
{{< /code-block >}}

## コンテキスト変数

有用なワークフローを作成するためには、あるステップから別のステップにデータを渡したり、ワークフローのトリガーソースからのデータで動作するステップを構成することが必要になることがあります。このようなデータ補間は、コンテキスト変数で行うことができます。

コンテキスト変数には、以下の種類があります。
- 標準的な**ワークフロー変数**の小さなコレクションは、すべてのワークフローに存在します。
- 一部のステップには**ステップ出力変数**が組み込まれており、そのステップからワークフロー内の後続のステップにデータを渡すことができるようになっています。
- **トリガー変数**は、トリガーとなるイベントによってワークフローに渡されます。
- **ソースオブジェクト変数**は、トリガーとなるイベントによってワークフローに渡されます。

各ステップの **Context Variables** タブには、そのステップで利用可能なすべてのコンテキスト変数のマップが表示されます。

{{< img src="workflows/context-variables.png" alt="Context Variables タブ" >}}

ステップ内のコンテキスト変数は、二重中括弧 (`{{`) で囲んでアクセスします。コンテキスト変数は `{{` 表記でマークされたフィールドで利用可能です。
{{< img src="workflows/use-context-variable.mp4" alt="サポートされているテキストフィールドで二重フェンスを使用し、コンテキスト変数を挿入する" video="true" >}}

### ワークフロー変数

すべてのワークフローには、3 つの標準変数があります。
- `WorkflowName`: ワークフローの名前。`{{ WorkflowName }}` でアクセスします。
- `WorkflowId`: ワークフロー ID。`{{ WorkflowId }}` でアクセスします。
- `InstanceId`: 各ワークフローは一意のインスタンス ID を受け取ります。インスタンス ID には `{{ InstanceId }}` でアクセスします。

### ステップ出力変数

ステップによっては、ワークフロー内の後続のステップで利用可能な出力を作成するものもあります。構文 `Steps.<step_name>.<variable>` を使ってステップ変数にアクセスします。例えば、GitHub のプルリクエストステータスステップ (`Get_pull_request_status`) からプルリクエストステータス変数 (`state`) を取得するには、次のコンテキスト変数を使用します。

```
{{ Steps.Get_pull_request_status.state }}
```

探している変数がわからない場合、Datadog は入力中に既存のステップを提案します。また、[Context Variables](#context-variables) タブで利用可能な変数のリストを参照することもできます。

### トリガー変数

トリガー変数を入力としてワークフローに渡すことができます。ワークフローは、カンマで区切られたキーと値のペアの JSON オブジェクトを受け付けます。ワークフローのステップでトリガー変数にアクセスするには、構文 `{{ Trigger.key }}` を使用します。例えば、トリガー変数 `{ "user": "Bits" }` にアクセスするには、ステップ内で ` {{ Trigger.user }}` を使用します。

- 存在しないトリガー変数を追加した場合、その変数は自動的にワークフロー入力として追加されます。
- 探している変数がわからない場合、Datadog は入力中に既存のステップを提案します。また、[Context Variables](#context-variables) タブで利用可能な変数のリストを参照することもできます。

{{< img src="workflows/add-trigger-variable.mp4" alt="ステップにトリガー変数を追加すると、自動的にワークフローに追加される" video="true" >}}

ワークフローのトリガーについては、[ワークフローをトリガーする][2]を参照してください。

### ソースオブジェクト変数

ソースオブジェクト変数は、トリガーイベントのプロパティで、実行時に解決されます。ワークフローで利用可能な変数は、ワークフローインスタンスを開始したトリガーのタイプに依存します。例えば、ワークフローインスタンスがモニターによってトリガーされた場合、モニター ID 変数は `{{Source.monitor.id}}` を使って利用することができます。もし、ワークフローがセキュリティシグナル検出または通知ルールによってトリガーされた場合、シグナル ID は `{{Source.securitySignal.id}}` を使用して利用可能です。

ソースオブジェクトのすべての変数が Context Variables タブに表示されます。

{{< img src="workflows/context-variables-tab-source-object-variables.png" alt="Context Variables タブのソースオブジェクト変数" >}}

## エラー処理とフォールバック

ステップに失敗した場合、ワークフローがステップを再試行する回数と間隔を指定して、オプションのフォールバックステップに移行することができます。フォールバックステップを指定しない場合、ワークフローはすべての再試行が終了した後、終了します。

ステップのエラー処理を構成するには
1. ワークフローキャンバスのステップをクリックします。
1. **Error Handling & Retries** セクションの横にある **+** アイコンをクリックします。
1. **Interval** と **Max retries** の値を調整します。
1. オプションで、[フォールバックステップを追加](#add-a-fallback)します。
1. ワークフローを保存して、変更を適用します。 

{{< img src="workflows/error-handling.png" alt="エラー処理と再試行のセクション" style="width:100%;" >}}

### フォールバックを追加する

ステップの失敗を処理するために、**Fallback** ドロップダウンメニューから選択することで、ダウンストリームのワークフローのステップをフォールバックとして追加することができます。

また、メインのワークフローツリーから分岐するフォールバックステップを作成することも可能です。
1. **Fallback** ドロップダウンメニューから、**Add a new fallback** を選択します。ワークフローキャンバスがフォールバックツリーに置き換わります。
1. フォールバックツリー上の **+** アイコンをクリックして、ステップを追加します。
1. [ワークフロービルダーを使ってステップを追加](#build-a-workflow-with-the-workflow-builder)します。フォールバックツリーには、必要な数のステップを追加することができます。
1. フォールバックステップの構成が完了したら、**Save** をクリックして変更を適用します。

メインのワークフローキャンバスに戻るには、フォールバックツリーの上にある **Main** をクリックします。ワークフローキャンバスから、フォールバックがあるステップの横にフォールバックアイコンが表示されます。アイコンをクリックし、フォールバックステップを選択すると、フォールバックツリーが表示されます。または、ステップの **Error Handling & Retries** セクションの **Edit Fallback Tree** をクリックして、フォールバックツリーにアクセスすることもできます。**Edit Fallback Tree** ボタンは、フォールバックステップがメインワークフローの既存のダウンストリームステップでない場合にのみ表示されます。

{{< img src="workflows/fallback-icon.png" alt="フォールバックのあるステップ" style="width:60%;" >}}

### フォールバックを削除する

1. メインワークフローキャンバスから、削除したいフォールバックを持つステップをクリックします。
1. **Error Handling &amp; Retries** セクションで、**Clear** をクリックします。

## その他の参考資料

{{< partial name="whats-next/whats-next.html" >}}

[1]: https://app.datadoghq.com/workflow
[2]: /ja/workflows/trigger