---
kind: Documentation
title: 高度なコンフィギュレーション
---

### 複数のアグリゲーターデプロイ

[ネットワーキング][1]で説明したように、Datadog では、1 つのリージョンにつき 1 つの観測可能性パイプラインワーカーアグリゲーターで始めることを推奨しています。これは、観測可能性パイプラインワーカーの最初のデプロイを複雑にしすぎないためですが、複数のデプロイで開始することが理想的な状況もあります。

1. **公衆インターネット上でのデータ送信を防止する。**複数のクラウドやリージョンがある場合、インターネット上に大量のデータを送信しないように、それぞれのクラウドやリージョンに観測可能性パイプラインワーカーアグリゲーターをデプロイしてください。観測可能性パイプラインワーカーアグリゲーターは、内部データを受け取り、ネットワークの単一のイグレスとして機能する必要があります。

2. **独立した管理。**ユースケースに応じて、観測可能性パイプラインワーカーアグリゲーターを独立して運用・管理できるチームがある場合です。例えば、データサイエンスチームは、独自のインフラストラクチャーを運用する責任があり、独自の観測可能性パイプラインワーカーアグリゲーターを独立して運用する手段を持っている場合があります。

### 複数のクラウドアカウント

多くのユーザーは、VPC とクラスターを内部に持つ複数のクラウドアカウントを持っています。Datadog はこのような場合でも、1 つのリージョンに 1 つの観測可能性パイプラインワーカーアグリゲーターを導入することを推奨しています。観測可能性パイプラインワーカーをユーティリティやツールのクラスターにデプロイし、すべてのクラウドアカウントがこのクラスターにデータを送信するように構成します。詳細については、[ネットワーキング][1]を参照してください。

### Pub-Sub システム

Kafka のようなパブリッシュ・サブスクライブ (Pub-Sub) システムを使用することは、アーキテクチャを高可用性または高耐久性にするために必須ではありませんが ([高可用性と災害復旧][2]を参照)、次のような利点があります。

1. **信頼性の向上。**Pub-Sub システムは、高い信頼性と耐久性を持ち、頻繁に変更されることのないシステムとして設計されています。マネージドオプションを使用している場合は特に信頼性が高くなります。観測可能性パイプラインワーカーは、その目的から頻繁に変更される可能性があります。観測可能性パイプラインワーカーのダウンタイムを Pub-Sub システムの背後に分離することで、クライアントの認識から可用性を高め、復旧をよりシンプルにすることができます。


2. **ロードバランサーが不要。**Pub-Sub システムは、ロードバランサーを必要としません。Pub-Sub システムがコンシューマーの調整を行うため、観測可能性パイプラインワーカーを簡単に水平にスケールすることができます。

#### Pub-Sub パーティショニング

パーティショニング (Kafka 用語では「トピック」) とは、Pub-Sub システム内のデータを分離することを指します。データを生成したサービスやホストなど、データの起点に沿ったパーティショニングを行う必要があります。

{{< img src="observability_pipelines/production_deployment_overview/partitioning.png" alt="ノード上の Agent が、Pub-Sub の 4 つのサービスにデータを送信し、そのデータを 4 つの観測可能性パイプラインワーカーに送信する図" style="width:55%;" >}}

#### Pub-Sub 構成

Pub-Sub システムを使用する場合、Datadog は、観測可能性パイプラインワーカーの以下の構成変更を推奨しています。

- **すべてのシンクでエンドツーエンドの確認応答を有効にする。**この設定により、データの書き込みが成功するまで Pub-Sub チェックポイントを進めないようにします。
- **メモリバッファを使用する。**観測可能性パイプラインワーカーが Pub-Sub システムの背後にある場合、観測可能性パイプラインワーカーのディスクバッファを使用する必要はありません。Pub-Sub システムは、高い耐久性を持つ長期的なバッファリングのために設計されています。観測可能性パイプラインワーカーは、データの読み取り、処理、ルーティングのみを担当する必要があります (耐久性ではありません)。

### グローバル集計

このセクションでは、レガシーの宛先に対してグローバル計算を実行するための推奨事項を説明します。最新の宛先は、すでにグローバル計算をサポートしています。例えば、Datadog は、メトリクスデータのグローバルな観測を解決するディストリビューション (DDSketch など) をサポートしています。

グローバル集計とは、リージョン全体のデータを集計する機能です。例えば、CPU 負荷平均のグローバル分位を計算することができます。これを実現するには、1 つの観測可能性パイプラインワーカーインスタンスが、すべてのノードの CPU 負荷平均統計にアクセスできる必要があります。これは水平スケーリングでは不可能です。個々の観測可能性パイプラインワーカーインスタンスは、全体のデータのスライスにしかアクセスすることができません。したがって、集計は階層化する必要があります。

{{< img src="observability_pipelines/production_deployment_overview/global_aggregation.png" alt="ロードバランサーが、複数の観測可能性パイプラインワーカーのある第 1 層のアグリゲーターにデータを送り、第 1 層から 1 つのワーカーを持つ第 2 層のアグリゲーターにデータを送る様子を示した図" style="width:90%;" >}}

上の図では、第 2 層のアグリゲーターは、第 1 層のアグリゲーターから全体データの集計されたサブストリームを受け取っています。これにより、単一のインスタンスが、ストリーム全体を処理し、単一障害点を導入することなく、グローバルビューを取得することができます。

#### 推奨事項

- グローバル集計は、グローバルヒストグラムの計算など、データを減らすことができるタスクに限定します。すべてのデータをグローバルアグリゲーターに送りません。
- 単一障害点を発生させないために、ほとんどのデータの処理と配信には、引き続きローカルアグリゲーターを使用してください。

[1]: /ja/observability_pipelines/architecture/networking
[2]: /ja/observability_pipelines/architecture/availability_disaster_recovery