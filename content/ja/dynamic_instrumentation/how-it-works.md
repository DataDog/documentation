---
kind: documentation
private: true
title: ダイナミックインスツルメンテーションの仕組み
---


## 概要

ダイナミックインスツルメンテーションは、サードパーティライブラリであっても、コードの任意の位置にプローブを追加して、実稼働システムに適用することができます。ダイナミックインスツルメンテーションは、オーバーヘッドが少なく、システムに対する副作用がないことが保証されています。

## プローブタイプ

*スナップショットプローブ*と*メトリクスプローブ*を作成することができます。

### スナップショットプローブ

スナップショットプローブは、以下のようなメソッドやラインのコンテキストをキャプチャします。

  - **メソッド引数**、*ローカル変数**、*フィールド**。以下の制限があります。
    - クラスオブジェクトの 3 階層分の深さ。
    - コレクション内の最初の 100 項目。
    - 文字列値で 255 文字。
    - オブジェクト内の 20 個の収集フィールド。静的フィールドは収集されません。
  - **スタックトレース**を呼び出します。
  - 捕捉される場合と捕捉されない場合の**例外**。

スナップショットプローブは、1 秒間に 1 スナップショットまでというレート制限があります。

**注**: キャプチャの上限は構成可能で、ダイナミックインスツルメンテーションのベータ版であるため、変更される可能性があります。

### メトリクスプローブ

メトリクスプローブは、動的なメトリクスを生成します。引数やローカル変数、フィールドをメトリクスの値として使用します。メトリクスプローブはレート制限を受けず、メソッドや行が起動されるたびに呼び出されます。

ダイナミックメトリクスプローブは、以下のメトリクスタイプをサポートしています。

- [**カウント**][1]: 指定されたメソッドや行が何回実行されたかを数えます。変数の値を数えるために[メトリクス式](#metric-expressions)と組み合わせることができます。
- [**ゲージ**][2]: 変数の最後の値に基づいてゲージを生成します。このメトリクスは[メトリクス式](#metric-expressions)を必要とします。
- [**ヒストグラム**][3]: 変数の統計的分布を生成します。このメトリクスは[メトリクス式](#metric-expressions)を必要とします。


#### メトリクス式

メトリクス式は、動的なメトリクスを生成するために使用することができます。例えば、`#file.content.size` のような参照式を使用すると、ファイルサイズのヒストグラムを作成することができます。

参照式の最初の部分は、変数ソースを示すプレフィックスです。

- `.` (ピリオド) - ローカルクラスのフィールドにアクセスします
- `#` (ハッシュ) - ローカル変数にアクセスします
- `^` (キャレット) - メソッドの引数にアクセスします

複数の参照セグメントを使用して、内部フィールドにアクセスすることができます。メトリクス式は、オブジェクトのフィールド (public あるいは private) にのみアクセスすることができます。参照式のフィールドが存在しないか null を返すと、参照パスは終了します。

[1]: /ja/metrics/types/?tab=count#metric-types
[2]: /ja/metrics/types/?tab=gauge#metric-types
[3]: /ja/metrics/types/?tab=histogram#metric-types