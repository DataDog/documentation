---
aliases:
- /ja/tracing/dynamic_instrumentation/
further_reading:
- link: /dynamic_instrumentation/how-it-works/
  tag: ドキュメント
  text: ダイナミックインスツルメンテーションの仕組みについて
- link: /tracing/trace_collection/dd_libraries
  tag: ドキュメント
  text: アプリケーションのインスツルメンテーションの方法について
- link: /getting_started/tagging/unified_service_tagging/
  tag: ドキュメント
  text: 統合サービスタグ付け
- link: /tracing/services/services_list/
  tag: ドキュメント
  text: Datadog に報告するサービスの一覧
- link: /metrics
  tag: ドキュメント
  text: メトリクスについて
is_beta: true
kind: documentation
private: true
title: ダイナミックインスツルメンテーション
---

{{< callout url="https://www.datadoghq.com/dynamic-instrumentation-request/" >}}
  ダイナミックインスツルメンテーションは、非公開ベータ版です。アクセスしたい場合は、このフォームに記入してください。
{{< /callout >}}

ダイナミックインスツルメンテーションにより、コードの変更や再デプロイメントを行うことなく、ライブアプリケーションからデータをキャプチャすることができます。

## はじめに

### 要件
ダイナミックインスツルメンテーションには、以下のものが必要です。

- [Datadog Agent][1] 7.41.1 以降がサービスと一緒にインストールされていること。
- その Agent で[リモート構成][2]が有効になっていること。
- Java アプリケーションの場合、トレーシングライブラリ [`dd-trace-java`][3] 1.8.0 以降。
- Python アプリケーションの場合、トレーシングライブラリ [`dd-trace-py`][4] 1.7.5 以降。
- .NET アプリケーションの場合、トレーシングライブラリ [`dd-trace-dotnet`][5] 2.23.0 以降。
- [統合サービスタグ付け][6]タグ `service`、`env`、`version` がデプロイメントに適用されていること。
- オプションで、サービスに[ソースコードインテグレーション][7]が設定されていること。

**注**: ダイナミックインスツルメンテーションページにアクセスするには、`debugger_read` および `debugger_write` 権限が必要です。ロールの詳細およびユーザーへのロールの割り当て方法については、[ロールベースのアクセス制御][8]を参照してください。

### ログのインデックスを作成する

ダイナミックインスツルメンテーションのログは Datadog に送信され、アプリケーションのログと一緒に表示されます。

[除外フィルター][9]を使用する場合は、ダイナミックインスツルメンテーションのログがフィルターされないようにします。

1. ログインデックスを作成し、**サンプリングなし**で希望する保存期間まで[構成][10]します。
2. `source:dd_debugger` にマッチするようにフィルターを設定します (すべてのダイナミックインスツルメンテーションログはこのソースを持ちます)。
3. 新しいインデックスが、そのタグにマッチする他のフィルターよりも優先されることを確認してください。先にマッチした方が勝つからです。

### ダイナミックインスツルメンテーションを有効にする

サービス上でダイナミックインスツルメンテーションを有効にするには、そのランタイムを選択し、セットアップの指示に従います。

{{< partial name="dynamic_instrumentation/dynamic-instrumentation-languages.html" >}}

## ダイナミックインスツルメンテーションを見る

ダイナミックインスツルメンテーションは、アプリケーションがランタイムに何をしているかを理解するのに役立ちます。ダイナミックインスツルメンテーションのプローブを追加することで、コードの変更や再デプロイメントを行うことなく、アプリケーションから追加のデータをエクスポートすることができます。

### プローブの作成

ログプローブ、メトリクスプローブともに、初期設定は同じです。

1. [ダイナミックインスツルメンテーションのページ][12]へ移動します。
1. 右上の **Create Probe** をクリックするか、サービス上で 3 つの点のコンテキストメニューをクリックし、**Add the probe for this service** を選択します。
1. あらかじめ入力されていない場合は、リストからサービスを選択します。
1. あらかじめ入力されていない場合は、ランタイム、環境、バージョンを選択します。
1. ソースコードで、クラスとメソッド、またはソースファイルと行のいずれかを選択して、プローブを設定する場所を指定します。
   サービスにソースコードインテグレーションを設定している場合、オートコンプリートは、ファイルを選択すると候補を表示し、ファイルのコードを表示するので、行を選択することができます。

### ログプローブの作成

*ログプローブ*は、実行時にログを出力します。

ログプローブで `Capture method parameters and local variables` を有効にすると、実行コンテキストから以下の値もキャプチャして、ログイベントに追加します。
- メソッド引数
- ローカル変数
- クラスフィールド
- 呼出しスタック
- 例外
キャプチャした値は Datadog UI で確認することができます。

このデータのキャプチャはパフォーマンスに大きく影響するため、プローブの環境およびバージョン設定に一致するサービスの 1 つのインスタンスでのみ有効になります。キャプチャを有効にしたプローブは、1 秒間に 1 回実行するようレートが制限されます。

指定された環境とバージョンに一致するすべてのサービスインスタンスで、余分なデータキャプチャのないログプローブが有効になります。また、各サービスインスタンスで 1 秒間に最大 5000 回までしか実行できないようにレート制限されています。

詳しくは、[ダイナミックインスツルメンテーションの仕組み][11]をご覧ください。

ログプローブを作成するには

1. 一般的なプローブのセットアップを完了します (サービス、環境、バージョン、プローブの場所を選択します)。
1. プローブタイプとして **Log** を選択します。
1. ログメッセージテンプレートを定義します。ダイナミックインスツルメンテーション式言語を使用して、実行コンテキストから値を参照することができます。
1. オプションで、プローブからの追加データキャプチャを有効にします。
1. オプションで、ダイナミックインスツルメンテーション式言語を使用して、条件を定義します。式が真と評価されたときにログが出力されます。

{{< img src="dynamic_instrumentation/log_probe.png" alt="ダイナミックインスツルメンテーションのログプローブの作成" >}}

### メトリクスプローブの作成

*メトリクスプローブ*は、実行時にメトリクスを出力します。

メトリクスプローブは、構成された環境とバージョンに一致するすべてのサービスインスタンスで自動的に有効化されます。
ダイナミックインスツルメンテーション式言語を使用して、変数、クラスフィールド、または数値を生成する式などのコンテキストから数値を参照することができます。
詳細は、[ダイナミックインスツルメンテーションの仕組み][11]をご覧ください。

メトリクスプローブを作成するには

1. 一般的なプローブのセットアップを完了します (サービス、環境、バージョン、プローブの場所を選択します)。
1. プローブタイプとして **Metric** を選択します。
1. メトリクスの名前を指定します。この名前のプレフィックスは `dynamic.instrumentation.metric.probe.` となります。
1. メトリクスタイプ (カウント、ゲージ、ヒストグラム) を選択します。
1. Debugger 式言語を使用して、メトリクスの値を選択します。カウントメトリクスの場合、これはオプションで、省略すると、起動のたびにカウントが 1 つずつ増えます。

{{< img src="dynamic_instrumentation/metric_probe.png" alt="ダイナミックインスツルメンテーションのメトリクスプローブの作成" >}}

## その他の参考資料

{{< partial name="whats-next/whats-next.html" >}}

[1]: /ja/agent/
[2]: /ja/agent/guide/how_remote_config_works/
[3]: https://github.com/DataDog/dd-trace-java
[4]: https://github.com/DataDog/dd-trace-py
[5]: https://github.com/DataDog/dd-trace-dotnet
[6]: /ja/getting_started/tagging/unified_service_tagging/
[7]: /ja/integrations/guide/source-code-integration/
[8]: /ja/account_management/rbac/permissions#apm
[9]: /ja/logs/log_configuration/indexes/#exclusion-filters
[10]: /ja/logs/log_configuration/indexes/#add-indexes
[11]: /ja/dynamic_instrumentation/how-it-works/
[12]: https://app.datadoghq.com/dynamic-instrumentation