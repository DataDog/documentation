---
aliases:
- /ja/tracing/dynamic_instrumentation/
- /ja/dynamic_instrumentation/how-it-works/
further_reading:
- link: /dynamic_instrumentation/expression-language/
  tag: ドキュメント
  text: ダイナミックインスツルメンテーション式言語について
- link: dynamic_instrumentation/sensitive-data-scrubbing/
  tag: ドキュメント
  text: ダイナミックインスツルメンテーションデータからの機密情報の削除
- link: /tracing/trace_collection/dd_libraries
  tag: ドキュメント
  text: アプリケーションのインスツルメンテーションの方法について
- link: /getting_started/tagging/unified_service_tagging/
  tag: ドキュメント
  text: 統合サービスタグ付け
- link: /tracing/service_catalog/
  tag: ドキュメント
  text: Datadog に報告するサービスの発見とカタログ化
- link: /metrics
  tag: ドキュメント
  text: メトリクスについて
- link: https://www.datadoghq.com/blog/dynamic-instrumentation-application-logging/
  tag: ブログ
  text: Datadog ダイナミックインスツルメンテーションを使用して、再デプロイせずにアプリケーションログを追加する
is_beta: false
private: false
title: ダイナミックインスツルメンテーション
---

## 概要

ダイナミックインスツルメンテーションを使用すると、再起動することなく、サードパーティのライブラリを含むアプリケーションのコードの任意の場所で、実行中の本番システムにインスツルメンテーションを追加することができます。Datadog の UI から、ログ、メトリクス、スパン、および対応するタグ付けのテレメトリーを追加または変更することができます。ダイナミックインスツルメンテーションはオーバーヘッドが少なく、システムに副作用を与えません。

ダイナミックインスツルメンテーションの最新のユーザーエクスペリエンス改善を試したい場合は、[オートコンプリートと検索の公開ベータ版][17]への参加をご検討ください。

## はじめに

### 前提条件

ダイナミックインスツルメンテーションには、以下のものが必要です。

- [Datadog Agent][1] 7.45.0 以降がサービスと一緒にインストールされていること。
- その Agent で[リモート構成][2]が有効になっていること。
- Java アプリケーションの場合、トレーシングライブラリ [`dd-trace-java`][3] 1.34.0 以降。
- Python アプリケーションの場合、トレーシングライブラリ [`dd-trace-py`][4] 2.2.0 以降。
- .NET アプリケーションの場合、トレーシングライブラリ [`dd-trace-dotnet`][5] 2.54.0 以降。
- PHP アプリケーションの場合、トレーシングライブラリ [`dd-trace-php`][18] 1.4.0 以降。
- [統合サービスタグ付け][6]のタグ `service`、`env`、`version` がデプロイメントに適用されていること。
- [オートコンプリートと検索 (オープンベータ)][17] が有効になっていること (推奨事項)。
- サービスに[ソースコードインテグレーション][7]が設定されていること (推奨事項)。
- ダイナミックインスツルメンテーションページにアクセスするには、**ダイナミックインスツルメンテーションの 読み取り構成** (`debugger_read`) 権限が必要です。
- インスツルメンテーションを作成または変更するには、**Dynamic Instrumentation Write Configuration** (`debugger_write`) 権限が必要です。
- **Capture method parameters and local variables** (メソッドパラメーターとローカル変数をキャプチャする) オプションを使用するには、**Dynamic Instrumentation Capture Variables** (`debugger_capture_variables`) 権限が必要です。

 ロールの詳細と、ユーザーにロールを割り当てる方法については、[ロールベースのアクセス制御][8]を参照してください。

### ログのインデックスを作成する

ダイナミックインスツルメンテーションは、Datadog に送信され、通常のアプリケーションログと共に表示される「ダイナミックログ」を作成します。

[除外フィルター][9]を使用する場合は、ダイナミックインスツルメンテーションのログがフィルターされないようにします。

1. ログインデックスを作成し、**サンプリングなし**で希望する保存期間まで[構成][10]します。
2. `source:dd_debugger` タグに一致するようにフィルターを設定します。すべてのダイナミックインスツルメンテーションログはこのソースを持ちます。
3. 新しいインデックスが、そのタグに一致する他のフィルターよりも優先されることを確認してください。最初に一致したものが優先されるためです。

### ダイナミックインスツルメンテーションを有効にする

サービスでダイナミックインスツルメンテーションを有効にするには、[アプリ内設定ページ][16]にアクセスしてください。

より詳細な説明については、以下のランタイムを選択してください。

{{< partial name="dynamic_instrumentation/dynamic-instrumentation-languages.html" >}}


### 制限

- ダイナミックインスツルメンテーションは、Azure App Services やサーバーレス環境にはまだ対応していません。
- サポートは Python、Java、.NET、PHP で構築されたアプリケーションに限定されます。

## ダイナミックインスツルメンテーションを見る

ダイナミックインスツルメンテーションは、アプリケーションがランタイムに何をしているかを理解するのに役立ちます。ダイナミックインスツルメンテーションのプローブを追加することで、コードを変更したり再デプロイすることなく、アプリケーションから追加のデータをエクスポートすることができます。

### プローブの使用

プローブを使用すると、プログラムの実行を停止することなく、コード内の特定のポイントからデータを収集できます。

プローブの使用は、コードの変更、デプロイ、サービスの再起動を行うことなく、実行中のアプリケーションに動的なログ、メトリクス、スパンを追加して観測可能性を強化することと考えてください。ユーザーエクスペリエンスを妨げたり、長時間のデプロイを必要とすることなく、即座にデータを収集することができます。

開発者としては、プローブを「ブレークしないブレークポイント」と考えることもできます。従来のデバッグでは、ブレークポイントとはプログラムの実行を停止するポイントのことで、開発者はその時点でのプログラムの状態を検査することができます。しかし、実際の本番環境では、プログラムの実行を停止することは現実的ではありませんし、不可能です。プローブは、非侵入的な方法で本番環境の変数状態を検査できるようにすることで、このギャップを埋めます。

### プローブの作成

どのプローブタイプでも、初期設定は同じです。

1. [ダイナミックインスツルメンテーションのページ][12]へ移動します。
1. 右上の **Create Probe** をクリックするか、サービス上で 3 つの点のメニューをクリックし、**Add the probe for this service** を選択します。
1. あらかじめ入力されていない場合は、サービス、ランタイム、環境、バージョンを選択します。
1. ソースコードで、クラスとメソッド、またはソースファイルと行のいずれかを選択して、プローブを設定する場所を指定します。[オートコンプリートと検索の公開ベータ版][17]に参加している場合は、オートコンプリートがクラスまたはメソッドを選択するための候補を表示します。

各プローブタイプの具体的な作成手順については、以下の各プローブタイプを参照してください。

または、これらの他のコンテキストからプローブを作成することもできます。

プロファイリング
: プロファイラーのフレームグラフで、フレームのコンテキストメニューから **Instrument this frame with a probe** を選択すると、メソッドのプローブを作成できます。

エラー追跡
: スタックトレース上で、スタックフレームにカーソルを合わせ、** Instrument** をクリックします。これにより、プローブ作成フォームに問題のコンテキストが入力されます。


### ログプローブの作成

*ログプローブ*は、実行時にログを出力します。

ログプローブを作成するには

1. プローブタイプとして **Log** を選択します。
1. [一般的なプローブのセットアップ](#creating-a-probe)を完了します (サービス、環境、バージョン、プローブの場所を選択します)。
1. ログメッセージテンプレートを定義します。ダイナミックインスツルメンテーション式言語を使用して、実行コンテキストから値を参照することができます。
1. オプションで、プローブからの追加データキャプチャを有効にします。(ベータ版)
1. オプションで、ダイナミックインスツルメンテーション式言語を使用して、条件を定義します。式が真と評価された場合にログが出力されます。

ログプローブは、指定された環境とバージョンに一致するすべてのサービスインスタンスでデフォルトで有効になっています。また、サービスの各インスタンスで 1 秒間に最大 5000 回まで実行されるようレート制限されています。

すべてのログプローブにログメッセージテンプレートを設定する必要があります。テンプレートは、中括弧内に[式][15]を埋め込むことをサポートします。例: `User {user.id} purchased {count(products)} products`

[式言語][15]を使用してログプローブに条件を設定することもできます。式はブール値で評価される必要があります。式が true の場合、プローブは実行され、式が false の場合、データはキャプチャも出力もされません。

{{< img src="dynamic_instrumentation/log_probe.png" alt="ダイナミックインスツルメンテーションのログプローブの作成" >}}

**ベータ版**: ログプローブで **Capture method parameters and local variables** (メソッドパラメーターとローカル変数をキャプチャする) を有効にすると、すべての実行コンテキストがログイベントに追加されます。
  - **メソッド引数**、*ローカル変数**、*フィールド**。以下のデフォルトの制限があります。
    - 3 段階の深さのリファレンスをフォローします (UI で構成可能)。
    - コレクション内の最初の 100 項目。
    - 文字列値で最初の 255 文字。
    - オブジェクト内の 20 個のフィールド。静的フィールドは収集されません。
  - **スタックトレース**を呼び出します。
  - 捕捉される場合と捕捉されない場合の**例外**。

この設定を有効にしたプローブは、1 秒間に 1 回のヒットにレート制限されます。

<div class="alert alert-info"><p><strong>警告: キャプチャされたデータには、個人情報、パスワード、シークレット (例: AWS キー) などの機密情報が含まれている可能性があります。</strong></p><p>この情報が適切にマスキングされるようにするには<ul>
<li>Datadog ダイナミックインスツルメンテーションは、機密情報をマスキングするために、いくつかのテクニックを採用しています。デフォルトのメカニズムや、ニーズに合わせて拡張する方法の詳細については、<a href="/dynamic_instrumentation/sensitive-data-scrubbing/">機密データスクラビング</a>を参照してください。</li>
<li><strong>Capture method parameters and local variables</strong> オプションをオフにし、ログメッセージテンプレートに含める変数を明示的に選択します。こうすることで、ログプローブには、明確に指定した変数に関連するデータのみが含まれるようになり、意図しない機密データ漏えいのリスクを低減できます。</li>
<li>Datadog アカウントの管理者で、他のユーザーが <strong>Capture method parameters and local variables</strong> オプションを使用できないようにしたい場合は、Dynamic Instrumentation Capture Variables (<code>debugger_capture_variables</code>) 権限を取り消すことができます。</li></ul></p><p>また、このデータをログに記録する必要があるが、Datadog 製品でアクセスできることに関連するリスクを軽減したい場合は、<code>source:dd_debugger</code> に <a href="/logs/guide/logs-rbac/?tab=ui#restrict-access-to-logs">Restriction クエリ</a>を設定することで、組織内のどのユーザーがキャプチャデータを表示できるかを制限できます。</p></div>

### メトリクスプローブの作成

*メトリクスプローブ*は、実行時にメトリクスを出力します。

メトリクスプローブを作成するには

1. プローブタイプとして **Metric** を選択します。
1. [一般的なプローブのセットアップ](#creating-a-probe)を完了します (サービス、環境、バージョン、プローブの場所を選択します)。
1. メトリクスの名前を指定します。この名前には `dynamic.instrumentation.metric.probe.` がプレフィックスとして付きます。
1. メトリクスタイプ (カウント、ゲージ、ヒストグラム) を選択します。
1. [ダイナミックインスツルメンテーション式言語][15]を使用してメトリクスの値を選択します。メソッドパラメーター、ローカル変数、クラスフィールド、または数値を返す式など、実行コンテキストから任意の数値を使用できます。カウントメトリクスの場合、これはオプションで、省略するとすべての呼び出しでカウントが 1 つ増加されます。

{{< img src="dynamic_instrumentation/metric_probe.png" alt="ダイナミックインスツルメンテーションのメトリクスプローブの作成" >}}

メトリクスプローブは、構成された環境とバージョンに一致するすべてのサービスインスタンスで自動的に有効になります。メトリクスプローブはレート制限を受けず、メソッドまたは行が呼び出されるたびに実行されます。

ダイナミックインスツルメンテーションメトリクスプローブは、以下のメトリクスタイプをサポートしています。

- **カウント**: 指定されたメソッドや行が何回実行されたかを数えます。カウントを増加させるために変数の値を使用するために[メトリクス式][15]と組み合わせることができます。
- **ゲージ**: 変数の最後の値に基づいてゲージを生成します。このメトリクスは[メトリクス式][15]を必要とします。
- **ヒストグラム**: 変数の統計的分布を生成します。このメトリクスは[メトリクス式][15]を必要とします。

### スパンプローブの作成

*スパンプローブ*は、メソッドの実行時にスパンを出力します。

スパンプローブを作成するには

1. プローブタイプとして **Span** を選択します。
1. [一般的なプローブのセットアップ](#creating-a-probe)を完了します (サービス、環境、バージョン、プローブの場所を選択します)。

{{< img src="dynamic_instrumentation/span_probe.png" alt="ダイナミックインスツルメンテーションのスパンプローブの作成" >}}

[カスタムインスツルメンテーションによる新しいスパンの作成][13]の代替手段として、*スパンプローブ*を使用することができます。メソッドが例外をスローした場合、例外の詳細は新しく作成されたスパンの `error` タグに関連付けられます。

### スパンタグプローブの作成

*スパンタグ*プローブは、既存のスパンにタグ値を追加します。タグは、_アクティブ_スパンまたは_サービスエントリ_スパンに追加できます。
内部スパンはデフォルトでインデックス化されていないため、APM で検索できない可能性があることに注意してください。

スパンタグプローブを作成するには

1. プローブタイプとして **Span Tag** を選択します。
1. [一般的なプローブのセットアップ](#creating-a-probe)を完了します (サービス、環境、バージョン、プローブの場所を選択します)。
1. タグの名前を指定します。
1. [ダイナミックインスツルメンテーション式言語][15]を使用してタグの値を指定します。
1. オプションで、ダイナミックインスツルメンテーション式言語を使用して、条件を定義します。式が真と評価されたときにのみタグが追加されます。
1. オプションで、それぞれ独自の名前、式、オプションの条件を持つタグを追加できます。


{{< img src="dynamic_instrumentation/span_tag_probe.png" alt="ダイナミックインスツルメンテーションのスパンタグプローブの作成" >}}

[コードにタグを追加するためにカスタムインスツルメンテーションを使用する][14]方法の代替手段として、*スパンタグプローブ*を使用することができます。


## その他の参考資料

{{< partial name="whats-next/whats-next.html" >}}

[1]: /ja/agent/
[2]: /ja/agent/remote_config/
[3]: https://github.com/DataDog/dd-trace-java
[4]: https://github.com/DataDog/dd-trace-py
[5]: https://github.com/DataDog/dd-trace-dotnet
[6]: /ja/getting_started/tagging/unified_service_tagging/
[7]: /ja/integrations/guide/source-code-integration/
[8]: /ja/account_management/rbac/permissions#apm
[9]: /ja/logs/log_configuration/indexes/#exclusion-filters
[10]: /ja/logs/log_configuration/indexes/#add-indexes
[11]: /ja/dynamic_instrumentation/how-it-works/
[12]: https://app.datadoghq.com/dynamic-instrumentation
[13]: /ja/tracing/trace_collection/custom_instrumentation/java/#adding-spans
[14]: /ja/tracing/trace_collection/custom_instrumentation/java/#adding-tags
[15]: /ja/dynamic_instrumentation/expression-language
[16]: https://app.datadoghq.com/dynamic-instrumentation/setup
[17]: /ja/dynamic_instrumentation/symdb/
[18]: https://github.com/DataDog/dd-trace-php