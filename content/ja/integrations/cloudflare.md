---
app_id: cloudflare
app_uuid: e48a0b64-d3ad-436f-95d3-e0c81e6d51d1
assets:
  dashboards:
    Cloudflare-Overview: assets/dashboards/cloudflare_overview.json
  integration:
    auto_install: false
    events:
      creates_events: false
    metrics:
      check: cloudflare.requests.all
      metadata_path: metadata.csv
      prefix: cloudflare
    service_checks:
      metadata_path: assets/service_checks.json
    source_type_id: 215
    source_type_name: Cloudflare
  monitors:
    '[Cloudflare] Abnormal bandwidth being sent for zone': assets/monitors/bandwidth.json
    '[Cloudflare] Error Rate is higher than normal in zone': assets/monitors/error_rate.json
    '[Cloudflare] Error count is unusually high for worker script': assets/monitors/worker_error.json
    '[Cloudflare] High number of detected threats for zone': assets/monitors/threats.json
    '[Cloudflare] Hit Ratio is abnormally low for zone': assets/monitors/hit_ratio.json
author:
  homepage: https://www.datadoghq.com
  name: Datadog
  sales_email: info@datadoghq.com (日本語対応)
  support_email: help@datadoghq.com
categories:
- モニター
- ログの収集
- キャッシュ
- セキュリティ
custom_kind: integration
dependencies: []
display_on_public_website: true
draft: false
git_integration_title: cloudflare
integration_id: cloudflare
integration_title: Cloudflare
integration_version: ''
is_public: true
manifest_version: 2.0.0
name: cloudflare
public_title: Cloudflare
short_description: Monitor your Cloudflare Web traffic, DNS queries, security threats,
  and more.
supported_os: []
tile:
  changelog: CHANGELOG.md
  classifier_tags:
  - Category::Metrics
  - Category::Log Collection
  - Category::Caching
  - Category::Security
  - Offering::Integration
  configuration: README.md#Setup
  description: Monitor your Cloudflare Web traffic, DNS queries, security threats,
    and more.
  media:
  - caption: Cloudflare 概要ダッシュボード
    image_url: images/overview-dashboard.png
    media_type: image
  overview: README.md#Overview
  resources:
  - resource_type: blog
    url: https://www.datadoghq.com/blog/monitor-cloudflare-zero-trust/
  - resource_type: blog
    url: https://www.datadoghq.com/blog/cloudflare-monitoring-datadog/
  support: README.md#Support
  title: Cloudflare
---

<!--  SOURCED FROM https://github.com/DataDog/integrations-internal-core -->
## 概要

Integrate with Cloudflare to get your zone metrics, including web traffic, DNS queries, and threat insights. The integration is based on [Cloudflare's analytics API][1]. Learn more about what resources correspond with which metrics in [our documentation][2].

**Log Collection**: In addition to these metrics, Cloudflare allows customers to push logs directly into Datadog using Cloudflare Logpush. These detailed logs contain metadata generated by Cloudflare products and are helpful for debugging and creating analytics, especially when combined with logs from other sources. [Enable Cloudflare log collection][3] in combination with these metrics to get full visibility into your Cloudflare environment.

すぐに使えるダッシュボードは、アプリケーションのセキュリティとパフォーマンスを向上させます。この一元化されたダッシュボードにより、以下の要素が視覚化されます

- セキュリティ脅威
- HTTP リクエスト量とエラー率
- 往復時間とトラフィックフローの変更を含むロードバランシング
- ワーカースクリプトにおけるパフォーマンスの問題

Cloudflare インフラストラクチャーを深く洞察するリッチ化されたログと詳細なメトリクスにより、問題解決に必要なコンテキストを構築できます。

The integration works with [Datadog Cloud SIEM][4] to provide out-of-the-box threat detection for
- 不可能移動
- dangerous misconfigurations
- DDoS 攻撃

IP アドレスのブロックや Datadog でのケースの作成など、同梱されている Workflow Automation のブループリントを利用して、セキュリティ脅威をより迅速に緩和できます。

## セットアップ

Before you begin, you need a [Datadog account][5], with an [API key][6], and access to [Cloudflare Logpush][7], which requires an Enterprise account plan.

Cloudflare API トークンを使用する場合は、**Zone** > **Zone** > **Read** および **Zone** > **Analytics** > **Read** の権限を保有していることを確認してください。

### インストール

Install the integration with the Datadog [Cloudflare integration tile][8].

### 構成

1. Go to the **Configure** tab inside the Datadog [Cloudflare integration tile][8].
2. 監視するアカウントの電子メールアドレスと、API キーまたはトークンを入力します。Cloudflare API キーと API トークンは、Cloudflare アカウントの **My profile** > **Api Tokens** の下にあります。
3. アカウントの名前を追加します。この名前は任意で、メトリクスの `account` タグ内で使用されます。

### ログ収集

Cloudflare allows customers to push logs directly into Datadog using Cloudflare Logpush. You can manage the Logpush job with the [Cloudflare API](#cloudflare-api) or directly within your [Cloudflare dashboard](#cloudflare-dashboard).

Cloudflare インテグレーションパイプラインをインストールすると、特定の属性が自動的にリマップされます。どの属性がリマップされるかを確認するには

1. Navigate to [Logs Pipelines][9].
2. 右上の **Browse Pipeline Library** をクリックします。
3. 検索バーに `Cloudflare` と入力します。
4. **Cloudflare** をクリックすると、インストールされているリマッパーなどのプロセッサーのリストが表示されます。

#### Cloudflare API

1. Logpush ジョブエンドポイントへ POST をリクエストし、Logpush ジョブを作成します。以下のフィールドを含めます。
    * `name` (任意): ドメイン名をジョブ名として使用。
    * `destination_conf`: 以下のパラメーターからなるログの出力先。
        * `<DATADOG_ENDPOINT_URL>`: The Datadog HTTP logs intake endpoint, which can be either one below. You can find the difference at [Datadog API reference][10].
          * **v1:** `http-intake.logs.{{< region-param key="dd_site" >}}/v1/input`
          * **v2 (latest):** `http-intake.logs.{{< region-param key="dd_site" >}}/api/v2/logs`
        * `<DATADOG_API_KEY>`: 使用する Datadog API キー。
        * `ddsource`: `cloudflare` に設定。
        * `service` (任意): サービス名を指定。
        * `host` (任意): ホスト名を指定。
        * `ddtags` (任意): タグを指定。
    * `dataset`: The category of logs you want to receive. See the [Cloudflare Log fields][11] for a list of supported datasets.
    * `logpull_options` (optional): To configure fields, sample rate, and timestamp format, see the [Logpush API options][12]. Datadog mandates the use of **RFC 3339 format for timestamps** from Cloudflare, which is the default option used by Cloudflare.

    **リクエスト例**:

    ```bash
    curl -s -X POST 'https://api.cloudflare.com/client/v4/zones/<ZONE_ID>/logpush/jobs' \
    --header 'X-Auth-Key: <CLOUDFLARE_AUTH_KEY>' \
    --header 'X-Auth-Email: <CLOUDFLARE_AUTH_EMAIL>' \
    --header 'Content-Type: application/json' \
    --data-raw '{
       "name": "<NAME>",
       "destination_conf": "datadog://<DATADOG_ENDPOINT_URL>?header_DD-API-KEY=<DATADOG_API_KEY>&ddsource=cloudflare&service=cloudflare&ddtags=env:dev",
       "logpull_options": "fields=RayID,EdgeStartTimestamp&timestamps=rfc3339",
       "dataset": "http_requests"
    }'
    ```

    **応答例**:

    ```bash
    {
     "errors": [],
     "messages": [],
     "result": {
       "id": 100,
       "dataset": "http_requests",
       "enabled": false,
       "name": "<DOMAIN_NAME>",
       "logpull_options": "fields=RayID,EdgeStartTimestamp&timestamps=rfc3339",
       "destination_conf": "datadog://http-intake.logs.{{< region-param key="dd_site" >}}/v1/input?header_DD-API-KEY=<DD-API-KEY>&ddsource=cloudflare&service=cloudflare&ddtags=env:dev",
       "last_complete": null,
       "last_error": null,
       "error_message": null
     },
     "success": true
    }
    ```

    `id` の値をメモしておきます。上記の例では、`100` です。

2. ジョブを有効にします。応答で返されたジョブ ID を使用してリクエスト本文で `{"enabled": true}` を送信します。

    **リクエスト例**:

    ```bash
    curl -s -X PUT \
    https://api.cloudflare.com/client/v4/zones/<ZONE_ID>/logpush/jobs/<JOB_ID> -d'{"enabled":true}' | jq .
    ```

    **応答例**:

    ```bash
    {
      "errors": [],
      "messages": [],
      "result": {
        "id": 100,
        "dataset": "http_requests",
        "enabled": true,
        "name": "<DOMAIN_NAME>",
        "logpull_options": "fields=RayID,EdgeStartTimestamp&timestamps=rfc3339",
        "destination_conf": "datadog://{{< region-param key="dd_site" >}}?header_DD-API-KEY=<DATADOG-API-KEY>",
        "last_complete": null,
        "last_error": null,
        "error_message": null
      },
      "success": true
    }
    ```

#### Cloudflare ダッシュボード

1. Once you have connected a service with the Logpush section of the Cloudflare dashboard, select the dataset, select data fields, and then, under select destination, choose Datadog.
2. **Enter destination information** の下で Datadog の URL エンドポイントを入力します。

    ```
    http-intake.logs.{{< region-param key="dd_site" >}}/api/v2/logs?ddsource=cloudflare
    ```
    **注**: `ddsource=cloudflare` は必須です。ログを区別するために、オプションで `service`、`host`、`ddtags` などのパラメーターを追加することもできます。

    **例**:

    ```
    http-intake.logs.{{< region-param key="dd_site" >}}/api/v2/logs?service=<SERVICE>&host=<HOST>&ddsource=cloudflare
    ```

3. Datadog Cloudflare インテグレーションタイルのセットアップに使用した Datadog API キーを入力します。
4. アクセスを確認すると、**Prove ownership** の下に "Ready to push!" と表示されます。`Push` をクリックして完了します。

## 収集データ

### メトリクス

{{< get-metrics-from-git "cloudflare" >}}

#### Metric categories

以下の表では、収集されるメトリクスの種類と関連するメトリクスのプレフィックスについて説明します。

| **型**          | **説明**                              | **Metric Prefixes Collected**                                                                 |
|-------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|
| **Web Analytics** | Metrics related to web traffic and performance. | `cloudflare.requests.all`<br>`cloudflare.requests.cached`<br>`cloudflare.requests.uncached`<br>`cloudflare.requests.ssl.encrypted`<br>`cloudflare.requests.ssl.unencrypted`<br>`cloudflare.requests.country`<br>`cloudflare.requests.status`<br>`cloudflare.requests.content_type`<br>`cloudflare.requests.ip_class`<br>`cloudflare.bandwidth.all`<br>`cloudflare.bandwidth.cached`<br>`cloudflare.bandwidth.uncached`<br>`cloudflare.bandwidth.ssl.encrypted`<br>`cloudflare.bandwidth.ssl.unencrypted`<br>`cloudflare.bandwidth.country`<br>`cloudflare.bandwidth.content_type`<br>`cloudflare.threats.all`<br>`cloudflare.threats.type`<br>`cloudflare.threats.country`<br>`cloudflare.pageviews.all`<br>`cloudflare.pageviews.search_engine`<br>`cloudflare.uniques.all` |
| **DNS**           | Metrics related to DNS queries and response times. | `cloudflare.dns.query.all`<br>`cloudflare.dns.query.uncached`<br>`cloudflare.dns.query.stale`<br>`cloudflare.dns.response_time.avg`<br>`cloudflare.dns.response_time.median`<br>`cloudflare.dns.response_time.90p`<br>`cloudflare.dns.response_time.99p` |
| **Load Balancer** | Metrics related to load balancing pools.          | `cloudflare.load_balancer.pool.round_trip_time.average`<br>`cloudflare.load_balancer.pool.health.status` |
| **Worker Script** | Metrics related to Cloudflare Workers scripts.     | `cloudflare.workers.requests.all`<br>`cloudflare.workers.requests.errors`<br>`cloudflare.workers.requests.subrequests`<br>`cloudflare.workers.response_time.75p`<br>`cloudflare.workers.response_time.99p`|

#### 権限
Cloudflare API トークンでこれらのアクセス許可が有効になっていることを確認します。

| スコープ       | アクセス許可         |   ステータス    |
| ----------- | ------------------ | ----------- |
| アカウント     | アカウント分析  |    読み取り     |
| アカウント     | アカウント設定    |    読み取り     |
| アカウント     | ワーカースクリプト     |    読み取り     |
| Zone        | Zone               |    読み取り     |
| Zone        | 分析          |    読み取り     |
| Zone        | ワーカールート      |    読み取り     |
| Zone        | ロードバランサー     |    読み取り     |

### イベント

Cloudflare インテグレーションには、イベントは含まれません。

### サービスチェック

Cloudflare インテグレーションには、サービスのチェック機能は含まれません。

## トラブルシューティング

Need help? Contact [Datadog support][13].

[1]: https://developers.cloudflare.com/analytics/graphql-api/
[2]: https://docs.datadoghq.com/ja/integrations/cloudflare/#metric-categories
[3]: https://docs.datadoghq.com/ja/integrations/cloudflare/#log-collection
[4]: https://docs.datadoghq.com/ja/security/cloud_siem/
[5]: https://www.datadoghq.com/free-datadog-trial/
[6]: /ja/account_management/api-app-keys/#api-keys
[7]: https://developers.cloudflare.com/logs/about
[8]: https://app.datadoghq.com/integrations/cloudflare
[9]: https://app.datadoghq.com/logs/pipelines
[10]: https://docs.datadoghq.com/ja/api/latest/logs/
[11]: https://developers.cloudflare.com/logs/log-fields
[12]: https://developers.cloudflare.com/logs/logpush/logpush-configuration-api/understanding-logpush-api#options
[13]: https://docs.datadoghq.com/ja/help/
