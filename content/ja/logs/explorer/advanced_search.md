---
disable_toc: false
further_reading:
- link: logs/explorer/analytics
  tag: ドキュメント
  text: ログ分析の実行
- link: /logs/explorer/export
  tag: ドキュメント
  text: ログエクスプローラーからビューをエクスポートする
- link: /logs/explorer/saved_views/
  tag: ドキュメント
  text: 保存ビューについて
title: 高度な検索
---

## 概要

ログ検索の結果をさらに絞り込みたい場合は、[サブクエリ](#filter-logs-with-subqueries) を使用して結果を第 2 のログ グループと比較するか、[参照テーブル](#filter-logs-based-on-reference-tables) のデータを使ってログをフィルタリングします。

## サブクエリでログをフィルタリング

第 2 のクエリの結果に基づいてメイン クエリの結果を絞り込みたい場合にサブクエリを使用します。2 つのシナリオ例は [サブクエリの例](#subquery-examples) を参照してください。

サブクエリ フィルターを追加するには:

1. [Log Explorer][1] に移動します。
1. 検索バーにクエリを入力してログをフィルタリングします。これがメイン クエリです。
1. **+ Add** をクリックします。
1. **Add Query Filter** セクションで **Logs** を選択します。

これにより、クエリ エディタに新しい要素が追加されます:

{{< img src="logs/explorer/advanced_search/subquery.png" alt="メイン検索クエリの下にあるサブクエリ エディタ" style="width:95%;" >}}

1. **where** フィールドで、ドロップダウン メニューを使用して相関させたい属性を選択します。選択可能な属性は、メイン クエリで返されたログに含まれるものです。
1. **from** フィールドでサブクエリ フィルターを定義します。
1. サブクエリ フィルターの前にある **Select Column** ドロップダウン メニューで、サブクエリの結果をグループ化およびソートするための属性を選択します。
1. **IN** または **NOT IN** 演算子のどちらを使用するかを選択します:
    - **IN** 演算子の結果には、その属性値がサブクエリの結果にも含まれているログのみが含まれます。例: `service:a` によって生成されたログのうち、`service:b` のトップ ユーザーの 1 人でもあるユーザーに紐づくものだけを表示したい場合。
    - **NOT IN** 演算子の結果では、属性値がサブクエリの結果に含まれているログを除外します。例: `status:error` ログのみを見たいが、最終的に `status:success` ログに至ったユーザーに紐づく `status:error` ログは除外したい場合。詳細な例は [古いまたは置換済みのログをフィルタリング](#filter-outdated-or-superseded-logs) を参照してください。
1. 必要に応じて、照合対象とするサブクエリの属性値の数を減らします。デフォルト値および最大値は `1000` です。頻度が高い値の **top**、または頻度が低い値の **bottom** から選択します。

### サブクエリの例

以下は、ログから必要な情報を得るためにサブクエリを使用する必要があるシナリオです。

#### 古いまたは置換済みのログをフィルタリング

あなたが e コマース プラットフォームを運用していると仮定します。顧客が注文を試みるたびにログが生成されます。ウェブサイトの継続的な問題により失われた潜在的な購入額の合計を把握するために、ログを分析したいとします。

ただし、注文は成功するまでに複数回失敗することがあると気付きます。つまり、特定の注文 ID については、検索結果に `status:error` ログと `status:success` ログの両方のエントリが存在します。2 つのクエリから一意の注文 ID のリストを抽出した場合、この注文 ID は両方に現れます。サブクエリを使えば、相互排他的なリストを取得できます。

この例では、最終的に成功しなかった注文のログのみに関心があります。サブクエリ機能を使用して、最終的に成功した注文を除外するには:

1. `status:success` ログ向けのサブクエリを定義します。
1. **NOT IN** 演算子を選択して、サブクエリの結果セットから注文を除外します。

{{< img src="logs/explorer/advanced_search/filter_outdated_example.png" alt="最終的に成功した注文を除外する設定を示すクエリ エディタ" style="width:100%;" >}}

#### 異なるログ ソース間で相関付ける

あなたが `network_directory` という名前のサービスを持ち、組織内のすべての内部 ネットワーク リソースとそれらへのアクセスを監視していると仮定します。このサービスによって生成されるログ イベントには、標準の属性 (例えば `host`、`service`、`source`) に加えて、クライアントの IP アドレスのようなカスタム属性が含まれます。

さらに、すべての内部アセット (インフラストラクチャー、従業員のデバイスなど) を追跡する別のサービス、`device-manager` もあります。

継続中の攻撃を調査しており、ほぼすべてのエンドポイントで API リクエストが大幅に増加していることを観測しています。まず、異常なリクエスト ボリュームに関連する IP アドレスを特定し、ファイアウォール レベルでブロックできるようにしたいと考えています。ただし、社内の内部 サービスはこれらのエンドポイントの最大級の利用者でもあるため、誤ってブロックしないように、クエリ結果からそれらを除外する必要があります。

この例では、`service:network_directory` をメインのクエリとして使用し、次に `device-manager` サービス用のサブクエリフィルターを定義して、認識されたデバイスからの結果を除外します。

{{< img src="logs/explorer/advanced_search/narrow_dataset_example.png" alt="既知のデバイスの結果を除外する設定を示すクエリ エディタ" style="width:100%;" >}}

## リファレンステーブルに基づくログのフィルター

{{% filter_by_reference_tables %}}

{{< img src="logs/explorer/advanced_search/reference_table_join_filter.png" alt="参照テーブルの検索オプションが強調表示された Datadog Log Explorer。前述の手順に対応する番号付きステップを含む" border="true" popup="true" style="width:100%;" >}}

## 参考資料

{{< partial name="whats-next/whats-next.html" >}}

[1]: https://app.datadoghq.com/logs
[2]: /ja/integrations/guide/reference-tables/?tab=manualupload