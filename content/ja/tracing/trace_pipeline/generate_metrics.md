---
aliases:
- /ja/tracing/span_to_metrics/
- /ja/tracing/generate_metrics/
description: 取り込んだスパンからカスタムメトリクスを生成します。
further_reading:
- link: tracing/trace_pipeline
  tag: ドキュメント
  text: トレースの取り込みをカスタマイズし、重要なトレースを保持します。
- link: tracing/trace_search_and_analytics/query_syntax
  tag: ドキュメント
  text: 保持されたトレースに基づいて分析クエリとモニターを使用します。
title: スパンからメトリクスを生成する
---

{{< img src="tracing/apm_lifecycle/span_based_metrics.png" style="width:100%; background:none; border:none; box-shadow:none;" alt="スパンベースメトリクス" >}}

スパンが[保持フィルター][1]でインデックス化されているかどうかに関係なく、取り込んだスパンの 100% からメトリクスを生成します。

特定の固定クエリや比較にカスタムメトリクスを使用する一方、保持フィルターを作成することで、保持されたトレースとそのフレームグラフの任意のクエリと調査が可能になります。

**請求について:** 取り込まれたスパンから生成されたメトリクスは、[カスタムメトリクス][2] として請求されます。

たとえば、カスタムメトリクスを異常検知の視覚化やダッシュボードおよびモニターの作成に使用して、ビジネスコンテキストにとって重要なさまざまなパラメーターの傾向を把握することができます。生成されたすべてのメトリクスは、Datadog [カスタムメトリクス][3]として 15 か月間利用可能です。

| 理由                        | スパンから生成されたカスタムメトリクス                   | Retention Filters                           |
| -------------------------------------- | -------------------------------------- | --------------------------------- |
| 保持期間                     | 15 か月                    | 15 日             |
| 異常検知                           | 生成されたメトリクスに基づき[異常検知モニター][4]を作成します。                            | 分析を使用して過去 15 日間の動作を比較し、完全なトレースを表示して根本原因を調査します。                         |
| 完全なコンテキストで一致するトレースの調査                          | N/A - カスタムメトリクスは、関連するトレースを保持しません。                            | [保持フィルター][1]を使用して、ビジネスコンテキストに関連するトレースを正確に保持します。                            |
| 動作の粒度                           | 重要なエンドポイントまたはその他のカーディナリティの低いグループのカスタムメトリクスを作成します。                        | 特定のエンドポイントに[トレースエクスプローラー][5]を使用するか、[分析][6]で 'Group By' オプションを使用します。                    |
| 予測または複雑な数学                          | 生成されたメトリクスに基づき、[予測値モニター][7]を作成します。                          |   N/A                            |

スパンからメトリクスを生成するには、[APM のセットアップとコンフィギュレーション][8] ページで [Generate Metrics][9] タブを選択し、**New Metric** ボタンをクリックします。

<br>

{{< img src="tracing/span_to_metrics/GenerateMetrics.png" style="width:100%;" alt="取り込んだスパンからメトリクスを生成する" >}}


## スパンベースのメトリクスの作成

{{< img src="tracing/span_to_metrics/createspantometrics.png" style="width:100%;" alt="メトリクスの作成方法" >}}

1. **メトリクスクエリを定義する:** 必要なデータセットにフィルタリング用のクエリを追加することから始めます。[クエリ構文][10]は、APM 検索と分析と同じです。

1. **追跡するフィールドを定義する:** `*` を選択してクエリに一致するすべてのスパンのカウントを生成するか、属性 (たとえば、`@cassandra_row_count`) を入力して数値を集計し、対応するカウント、最小、最大、合計、および平均の集計メトリクスを作成します。属性タイプがメジャーの場合、メトリクスの値はスパン属性の値です。

   **注**: 数値でないスパン属性は集計に使用できません。スパン属性の異なる値をカウントするメトリクスを生成するには (例えば、特定のエンドポイントを訪問するユーザー ID の数をカウントする)、このディメンションを `group by` セレクタに追加し、`count_nonzero` 関数を使用してタグ値の数をカウントします。

1. **グループ化ディメンションを指定する:** デフォルトでは、スパンから生成されたメトリクスには、明示的に追加されない限りタグがありません。スパンに存在する属性またはタグを使用して、メトリクスタグを作成できます。

1. **ライブ分析と検索クエリのプレビューを確認する:** クエリがデータの視覚化に与える影響と、クエリで考慮される一致するスパンをライブプレビューでリアルタイムに表示できます。

1. **メトリクスに名前を付ける:** メトリクス名は、[メトリクス命名規則][11]に従う必要があります。`trace.*` で始まるメトリクス名は許可されておらず、保存されません。

<div class="alert alert-warning">スパンベースのメトリクスは<a href="/metrics/custom_metrics/">カスタムメトリクス</a>と見なされ、それに応じて請求されます。請求への影響を避けるために、タイムスタンプ、ユーザー ID、リクエスト ID、セッション ID などの無制限または非常に高いカーディナリティ属性によるグループ化は避けてください。</div>

## 既存のスパンベースのメトリクスの更新

{{< img src="tracing/span_to_metrics/editspantometrics.png" style="width:100%;" alt="既存のメトリクスを編集する" >}}

メトリクスの作成後、2 つのフィールドのみを更新できます。

| フィールド                                 | 理由                                                                                                             |
|----------------------------------------|-------------------------------------------------------------------------------------------------------------------------|
| Stream filter query                  | 一致するスパンのセットを変更して、メトリクスに集計します。            |
| 集計グループ             | タグを更新して、生成されたメトリクスのカーディナリティを管理します。                                                     |

**注**: メトリクスのタイプまたは名前を変更するには、新しいメトリクスを作成し、古いメトリクスを削除します。

## その他の参考資料

{{< partial name="whats-next/whats-next.html" >}}


[1]: /ja/tracing/trace_pipeline/trace_retention
[2]: /ja/account_management/billing/custom_metrics/
[3]: https://docs.datadoghq.com/ja/metrics/#overview
[4]: /ja/monitors/types/anomaly/#overview
[5]: /ja/tracing/trace_explorer/
[6]: /ja/tracing/trace_explorer/query_syntax/#analytics-query
[7]: /ja/monitors/types/forecasts/
[8]: https://app.datadoghq.com/apm/getting-started
[9]: https://app.datadoghq.com/apm/traces/generate-metrics
[10]: /ja/tracing/trace_explorer/query_syntax/
[11]: /ja/metrics/#naming-metrics