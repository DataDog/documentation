---
further_reading:
- link: /tracing/trace_ingestion/ingestion_controls/
  tag: ドキュメント
  text: 取り込み制御ページ
kind: ガイド
title: APM 分散型トレーシングによる取り込み量制御
---

## 概要

[取り込み制御ページ][1]は、Agent とトレーシングライブラリのすべてのサービスに対する取り込み構成に対するきめ細かい可視性を提供します。すべての[取り込みメカニズム][2]は公開されており、構成することができます。

取り込み制御ページでは、スパンボリュームを完全に可視化し、完全に制御することができます。その結果、以下のことが可能になります。
- ビジネスと観測可能性の目標に最も関連性の高いデータを取り込みます。
- 未使用のトレースデータを Datadog プラットフォームに送信しないようにすることで、ネットワークコストを削減します。
- 全体のコストをコントロールし、管理します。


## トレース取り込み量低減の効果


{{< img src="/tracing/guide/trace_ingestion_volume_control/sampling_25_percent.png" alt="25% のトレースが取り込まれたことを表示する APM 取り込みサンプリング" style="width:70%;" >}}

特定のサービスの取り込み量を減らすことにしても、**リクエスト、エラー、およびレイテンシーのメトリクス** (RED (Requests, Errors, and Duration) メトリクスとして知られている) は、サンプリング構成に関係なく、アプリケーションの 100% のトラフィックに基づいて計算されているため、100% の精度を維持します。これらのメトリクスは、Datadog APM の購入時に含まれています。アプリケーションのトラフィックを完全に可視化するために、これらのメトリクスを使用して、ダッシュボード、モニター、SLO を作成し、サービスやリソースの潜在的なエラーを発見することができます。

トレースデータは非常に反復性が高いため、取り込みサンプリングでも問題を調査するためのトレースサンプルは利用可能です。高スループットのサービスでは、通常、すべてのリクエストを収集する必要はありません。十分重要な問題は、常に複数のトレースで症状を示すはずです。取り込み制御は、予算の範囲内で、問題のトラブルシューティングに必要な可視性を確保するのに役立ちます。

## サービスの取り込み構成を評価する

アプリケーションのインスツルメンテーションの現状を評価するために、Agent とトレースライブラリの構成に関する詳細な情報を提供する[トレース取り込み制御ページ][1]を活用してください。



### 月間の取り込み割り当ての範囲内かどうかの把握

取り込み月間使用量 KPI を使用して、APM ホストごとに取り込まれるスパンの月間割り当て 150 GB (すべての APM ホストで合計) と比較して、使用量を推定します。

{{< img src="/tracing/guide/trace_ingestion_volume_control/ingestion_overage.png" alt="取り込みオーバー KPI: 全インフラストラクチャーで月間 23.3 TB の推定使用量の 170% を表示" style="width:40%;" >}}

### APM の高度な使用量調査

各サービスごとに取り込み構成を調べることができます。サービス行をクリックすると、Service Ingestion Summary が表示され、以下が示されます。
- **Ingestion reason breakdown**: どの[取り込みメカニズム][2]が取り込み量を担っているか
- **Top sampling decision makers**: [デフォルトの取り込みメカニズム][3]に関して、取り込まれたスパンに対してどの上流サービスがサンプリング決定をしているか

また、取り込みの使用や量に関する過去の傾向をより深く理解するための[すぐに使えるダッシュボード][4]も利用可能です。このダッシュボードを複製すると、ウィジェットの編集やさらなる分析が可能になります。

## 取り込み量を減らす

### 取り込み量の大部分を占めるサービスの特定

どのサービスが取り込み量の大部分を占めているかを確認するには、表を **Downstream Bytes/s** でソートします。この列では、どのサービスがサンプリング決定の大部分を行い、それが下流のサービスにも影響を及ぼしているかを見分けることができます。

サービスがスパンを開始している場合、**Downstream Bytes/s** には、サービスがサンプリング決定を行った下流サービスからのスパン量も含まれます。

一部の高スループットサービスのサンプリングレートを構成することで、「超過」取り込み量の大部分を低減することができます。

### どの取り込みメカニズムが取り込み量の大部分を担っているのかを特定する

**Traffic Breakdown** 列を見ると、サービスのサンプリング構成がよくわかります。

Downstream Bytes/s レートが高く、サンプリングレートも高いサービス (トラフィック内訳列の青く塗りつぶされた部分として表示) の場合、このサービスのサンプリングレートを下げると、取り込み量に高い影響を与えることが予想されます。

{{< img src="/tracing/guide/trace_ingestion_volume_control/sampling_99_percent.png" alt="99% のトレースが取り込まれたことを表示する APM 取り込みサンプリング、つまりサンプリングがない" style="width:70%;" >}}

詳細については、サービスをクリックし、サイドパネルの **Ingestion reasons breakdown** をご覧ください。各メカニズムに起因する取り込み量のシェアの概要を確認することができます。

トレースをサンプリングするデフォルトのメカニズムは、_ヘッドベースサンプリング_です。トレースをサンプリングするかどうかの判断はライフサイクルの最初に行われ、 常に完全なトレースを表示して分析できるようにするために、 リクエストのコンテキストで下流に伝搬されます。[デフォルトのサンプリングメカニズム][3]についてご覧ください。

取り込み制御ページに表示される取り込み理由と、 `datadog.estimated_usage.apm.ingested_bytes` メトリクスのタグは、取り込み量の原因になっている可能性があります。

- `auto`: ライブラリに対する Agent 分散レート
- `rule`: ライブラリの特定サービスに対するサンプリング率
- `manual`: スパンとその子を保持/削除するための、コード内決定のオーバーライド
- `analytics`: フルトレースなしで単一スパンをサンプリングする非推奨の取り込みメカニズム
- `error`: ヘッドベースサンプリングで捕捉できないエラーのサンプリング
- `rare`: レアトレースのサンプリング (設定されたスパンタグのすべての組み合わせを捕捉)

さらに、サンプリングされたスパン量には、他の製品が関与している可能性があります。

- `synthetics` & `synthetics-browser`: API およびブラウザテストは、テストによって生成されたトレースに接続されています。
- `rum`: Web アプリケーションやモバイルアプリケーションからのリクエストは、対応するバックエンドのトレースとリンクしています。
- `lambda` & `xray`: X-Ray または Datadog ライブラリでインスツルメントされた AWS lambda 関数から生成されたトレース。

### ライブラリレベルで取り込みサンプリングレートを構成する

取り込み量のほとんどの主な理由が `auto` または `rule` である場合、トレースライブラリレベルでサンプリングルールを設定することで、取り込み量を構成することができます。

サービスのサンプリングレートを構成するには、**Manage Ingestion Rate** ボタンをクリックします。サービスの言語と適用したい取り込みサンプリングレートを選択します。

**注:** 構成の変更を適用するには、アプリケーションを再デプロイする必要があります。Datadog では、[環境変数][5]を設定することで変更を適用することを推奨しています。


## その他の参考資料

{{< partial name="whats-next/whats-next.html" >}}

[1]: /ja/tracing/trace_ingestion/ingestion_controls
[2]: /ja/tracing/trace_ingestion/mechanisms
[3]: /ja/tracing/trace_ingestion/mechanisms/#head-based-default-mechanism
[4]: /ja/tracing/trace_retention/usage_metrics/
[5]: /ja/tracing/trace_ingestion/mechanisms/?tab=environmentvariables#in-tracing-libraries-user-defined-rules