---
code_lang: ddprof
code_lang_weight: 90
further_reading:
- link: /tracing/troubleshooting
  tag: Documentation
  text: APM Troubleshooting
title: Troubleshooting the Native Profiler for Compiled Languages
type: multi-code-lang
---

<div class="alert alert-warning">
<code>ddprof</code> はベータ版です。Datadog では、本番環境にデプロイする前に重要でない環境でプロファイラーを評価することを推奨しています。
</div>

## プロファイル検索ページにないプロファイル

プロファイラーを構成したのにプロファイル検索ページにプロファイルが表示されない場合は、冗長ロギング (`-l debug`) をオンにして[サポートチケットを開いてください][1]。サポートチケットには、ログファイルと以下の情報を記載してください。

- Linux カーネルバージョン (`uname -r`)
- libc バージョン (`ldd --version`)
- `/proc/sys/kernel/perf_event_paranoid` の値
- プロファイラーとアプリケーションの両方の引数を含む完全なコマンドライン

以下のセクションに、セットアップに関する潜在的な問題を示します。

### "\<ERROR\> Error calling perfopen on watcher"

このエラーは、通常、プロファイラーを作動させるのに十分な権限がない場合に発生します。最も一般的な理由は、必要なオペレーティングシステムの機能が無効になっており、プロファイリングに失敗することです。これは通常、ホストレベルの構成であり、個々のポッドやコンテナのレベルでは設定できません。

`perf_event_paranoid` が再起動後も持続するように設定することは、分布に依存します。診断の手順として、以下を試してみてください。

```shell
echo 1 | sudo tee /proc/sys/kernel/perf_event_paranoid
```

**注**: これは `/proc/sys/kernel/perf_event_paranoid` オブジェクトが存在し、書き込み可能なマウントネームスペースから実行する必要があります。コンテナ内では、この設定はホストから継承されます。

`perf_event_paranoid` の値をオーバーライドするために使用できる機能は 2 つあります。
- `CAP_SYS_ADMIN`: 多くの権限を追加するので、推奨されない場合があります。
- `CAP_PERFMON`: BPF と `perf_event_open` 機能を追加します (Linux v5.8 以降で使用可能)。

あまり一般的ではない権限の問題がいくつかあります。
- プロファイラーは `perf_event_open()` システムコールに依存していますが、コンテナランタイムによってはこれが許可されない場合があります。そのようなことがあるかどうかは、適切なドキュメントをチェックしてください。
- seccomp のプロファイルの中には `perf_event_open()` を禁止しているものがあります。お使いのシステムでそのような構成が行われている場合、プロファイラーを実行できないことがあります。

### "\<ERROR\> Could not mmap memory for watcher

プロファイラーが動作するには、固定されたメモリが必要です。このタイプのメモリはカーネルの設定によって制限されます。現在の設定は `ulimit -l` で確認できます。以下の機能を使うと、この制限を回避することができます。
- `CAP_IPC_LOCK`: ロックされたメモリ (ページングが免除されたメモリ) の使用を許可します。

### "\<WARNING\> Could not finalize watcher"

この警告は、システムがプロファイラーに十分なロックされたメモリーを割り当てられない場合に発生する可能性があります。この現象は、特定のホストでプロファイラーのインスタンスが多すぎる場合 (多くのコンテナ型サービスが同じホストで個別にインスツルメントされている場合など) によく発生します。この問題は、`mlock()` のメモリ制限を増やすか、インスツルメントされるアプリケーションの数を減らすことで解決できます。

他のプロファイリングツールも同様の制限に寄与する可能性があります。

### "\<WARNING\> Failure to establish connection"

このエラーは、通常、プロファイラーが Datadog Agent に接続できないことを意味します。構成ロギングを有効にして (`--show_config`)、プロファイラーがアップロードに使用するホスト名とポート番号を確認してください。さらに、エラーメッセージの内容から、使用されているホスト名とポートがわかります。これらの値を Agent の構成と比較してください。プロファイラーのヘルプセクション (`ddprof --help`) で、Agent の URL の構成についての詳細情報を確認してください。

## プロファイルが空またはまばらである

プロファイリングの root は、アプリケーションのバイナリでアノテーションされたフレームです。 このフレームがかなりの CPU 時間を示しているが、子フレームがない場合は、次のことを考慮してください。
- ストリップされたバイナリはシンボルが使用できません。ストリップされていないバイナリや、縮小されていないコンテナイメージを使ってみてください。
- 特定のアプリケーションやライブラリは、そのデバッグパッケージがインストールされていると便利です。これは、リポジトリのパッケージマネージャーなどでインストールされたサービスにも当てはまります。

関数名と思われる場所に `Anonymous` が表示される場合は、インタープリター言語か JIT 言語を使用している可能性があります。Perf マップや JIT ダンプ情報を有効にしてください。

プロファイルが空であるか ("No CPU time reported")、フレーム数が少ない可能性があります。アプリケーションにある程度の負荷がかかっていることを確認してください。プロファイラーがアクティブになるのは、インスツルメンテーションされたアプリケーションが CPU にスケジューリングされているときだけです。

## 共有ライブラリのロード中のエラー

コンパイル済み言語用の Continuous Profiler を動的ライブラリとして使用している場合、以下のエラーでアプリケーションが起動しないことがあります。

```
error while loading shared libraries: libdd_profiling.so: cannot open shared object file: No such file or directory
```

これは、アプリケーションが `libdd_profiling.so` の依存関係で構築されている場合に発生しますが、依存関係の調整中のランタイムでは見られません。以下のいずれかを実行することで修正できます。

- 静的ライブラリを使用してアプリケーションを再構築。一部の構築システムでは、動的ライブラリと静的ライブラリの選択があいまいなため、`ldd` を使用して `libdd_profiling.so` で結果のバイナリに不要な動的依存関係が含まれるかどうかを確認します。
- 動的リンカーの検索パスでディレクトリの 1 つに `libdd_profiling.so` をコピー。ほとんどの Linux システムで、`ld --verbose | grep SEARCH_DIR | tr -s ' ;' \\n` を実行することでこのディレクトリのリストを獲得できます。


## その他の参考資料

{{< partial name="whats-next/whats-next.html" >}}

[1]: /ja/help/