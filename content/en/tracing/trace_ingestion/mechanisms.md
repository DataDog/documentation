---
title: Ingestion Mechanisms
kind: documentation
description: "Overview of the mechanisms in the tracer and the Agent that control trace ingestion."
---

Multiple mechanisms are responsible for choosing if spans generated by your applications are sent to Datadog (_ingested_). The logic behind these mechanisms lie in the [tracing libraries][1] and in the Datadog Agent. Depending on the configuration, all or some the traffic generated by instrumented services is ingested.

To each span ingested, there is attached a unique **ingestion reason** referring to one of the mechanisms described in this page. Usage metrics `datadog.estimated_usage.apm.ingested_bytes` and `datadog.estimated_usage.apm.ingested_spans` are tagged by `ingestion_reason`.

## Head-based default mechanism
_ingestion\_reason : auto_

The default sampling mechanism is called _head-based sampling_. The decision of whether to keep or drop a trace is made at the very beginning of the trace, at the start of the [root span][2]. This decision is then propagated to other services as part of their request context, for example as an HTTP request header.

Because the decision is made at the beginning of the trace and then conveyed to all parts of the trace, the trace is guaranteed to be kept or dropped as a whole.

### In the agent

The datadog agent continuously sends sampling rates to tracing libraries to apply at the root of traces. Datadog agent adjusts rates targetting an overall  `10 traces-per-second`, distributed to services depending on the traffic.

For instance, if service `A` has more traffic than service `B`, the agent might vary the sampling rate for `A` such that  `A` keeps no more than `7` traces per second, and similarly adjust the sampling rate for `B` such that `B` keeps no more than `3` traces per second, for a total of `10` traces per second.

The agent's target traces-per-second can be set in its main configuration file (`datadog.yaml`) or as an environment variable :
```
@param max_traces_per_second - integer - optional - default: 10
@env DD_APM_CONFIG_MAX_TRACES_PER_SECOND - integer - optional - default: 10
```

### In Tracing librairies : User-defined Rules
_ingestion\_reason : rule_

At the library level, more specific sampling configuration is available:
- Set a specific sampling rate to apply to all root services, overriding the agent's [default mechanism](#default-mechanism).
- Set a sampling rate for a specific root service.
- Set a limit on the number of ingested traces-per-second.

**Note :** These rules also follow a head-based sampling mechanism. If the traffic for a service is higher than the configured maximum traces-per-second, then traces are dropped at the root. It does not create incomplete traces.

The configuration can be set directly in the code, or as environment variables :

{{< tabs >}}
{{% tab "Environment variables" %}}

```
@env  DD_TRACE_SAMPLE_RATE - integer - optional null (defaults to agent default feedback loop)
@env DD_TRACE_SAMPLING_RULES - integer - optional null
@env  DD_TRACE_RATE_LIMIT - integer - optional 100 (if using the agent default mechanism, the rate limiter is ignored)
```

{{% /tab %}}
{{% tab "Code API" %}}

```
# in dd-trace-py
# Sample 10% of all traces with rate limit of 100 traces per second sampled
# and an override sample rate for a specific service
tracer.configure(sampler=DatadogSampler(
    default_sample_rate=0.10, # keep 10% of traces
    rate_limit=100, # but at most 100 traces per second
    rules=[
      # 100% sampled for “my-service”, but the 100 traces-per-second overall limit is still honored
      SamplingRule(sample_rate=1.0, service=’my-service’),
    ],
)
```

{{% /tab %}}
{{< /tabs >}}

Read more about configuring the ingestion in the [tracing librairies][1] documentation

**Note :** Services configured with user-defined rules are marked as `Configured` in the [Ingestion Control Page][3] Configuration column. Services configured to use the default mechanism are labeled as `Automatic`.

## Force Keep and Drop
_ingestion\_reason : manual_

Head-based sampling mechanism can be overriden at the tracing library level. For instance, if you need to monitor a critical transaction, force the associated trace to be kept. On the other hand, for unnecessary or repetitive information like health checks, force the trace to be dropped.

- Set `ManualKeep` on a span to indicate that it and all child spans should be ingested. The resulting trace might appear incomplete in the UI if the span in question is not the root span of the trace.
```
// in dd-trace-go
span.SetTag(ext.ManualKeep, true)
```
- Set ManualDrop to make sure that **no** child span is ingested. [Error and rare samplers](#error-and-rare-traces) will be ignored in the agent.
```
span.SetTag(ext.ManualDrop, true)
```

## Single spans (App Analytics)
_ingestion\_reason : analytic_

<div class="alert alert-danger">
On October 20, 2020, App Analytics was replaced by Tracing without Limits.  This is a deprecated mechanism with configuration information relevant to legacy App Analytics. Now, instead, use Tracing without Limits™ head-based sampling to have full control over your <a href="https://docs.datadoghq.com/tracing/trace_ingestion/mechanisms#head-based-default-mechanism">data ingestion</a>.
</div>

If you need to sample a specific span, but don't need the full trace to be available, tracers allow a sampling rate to be configured for a single span. This span will be ingested at no less than the configured rate, even when the enclosing trace is dropped.

### In the tracing librairies

To use the analytics mechanism, it must be enabled, either in the code, or via an environment variable. Furthermore, define a sampling rate to be applied to all `analytics_enabled` span:

{{< tabs >}}
{{% tab "Environment variables" %}}

```
@env  DD_TRACE_ANALYTICS_ENABLED - boolean - optional false
```
{{% /tab %}}
{{% tab "Code API" %}}

```
// in dd-trace-go
// set analytics_enabled by default
tracerconfig.WithAnalytics(on bool)
// set raw sampling rate to apply on all analytics_enabled spans
tracerconfig.SetAnalyticsRate(0.4)
```

{{% /tab %}}
{{< /tabs >}}

Tag any single span with `analytics_enabled:true`. In addition, specify a sampling rate to be associated with the span:
```
// in dd-trace-go
// make a span analytics_enabled
span.SetTag(ext.AnalyticsEvent, true)
// make a span analytics_enabled with a rate of 0.5
s := tracer.StartSpan("redis.cmd", AnalyticsRate(0.5))
```

### In the agent

In the agent, an additional rate limiter is set to 200 spans per second. If the limit is reached, some spans are be dropped and not forwarded to Datadog.

The rate can be set in the agent main configuration file (datadog.yaml) or as an environment variable :
```
@param max_events_per_second - integer - optional 200
@env DD_APM_CONFIG_MAX_EVENTS_PER_SECOND - integer - optional 200
```

## Error and rare traces

For traces not caught by the head-based sampling, agent mechanisms make sure that critical and diverse traces are kept and ingested. These 2 samplers keep a diverse set of traces (by catching all combinations of a predetermined set of tags):

- **Error traces :** sampling errors is important to provide visibility on potential system failures
- **Rare traces :** sampling rare traces allows you to keep visibility on your system as a whole, by making sure that low-traffic services and resource are still monitored.


### Error traces
_ingestion\_reason : error_

The error sampler catches pieces of traces containing error spans that are not caught by head-based sampling. It distributes a `10 traces-per-second` rate to catch all combinations of `service`, `name`, `resource`, `http.status` and `error.type`.

From agent version 7.33, the error sampler can be configured in the agent main configuration file (datadog.yaml) or with environment variables :
```
@param errors_per_second - integer - optional - default: 10
@env DD_APM_ERROR_TPS - integer - optional - default: 10
```

**Note:** Set the parameter to `0` to disable the error sampler

### Rare traces
_ingestion\_reason : rare_

The rare sampler sends a set of rare spans to Datadog.
Rare sampler are also distributes a rate to catch combinations of `env`, `service`, `name`, `resource`, `error.type` and `http.status`. The default sampling rate for rare traces is `5 traces-per-second`.

From agent version 7.33, the rare sampler can be disabled in the agent main configuration file (datadog.yaml) or with an environment variable :

```
@params apm_config.disable_rare_sample - boolean - optional - default: false
@env DD_APM_DISABLE_RARE_SAMPLER - boolean - optional - default: false
```

**Note:** Sampled traces may be incomplete, as this mechanism occurs downstream of the head-based sampling. There is no way to guarantee that the agent will receive a complete trace from the tracing libraries.

## Product ingested spans

Some additional ingestion reasons are attributed to spans generated by a specific Datadog product.

| Product    | ingestion_reason                    |
|------------|-------------------------------------|
| Synthetics | `synthetics` & `synthetics-browser` |
| RUM        | `RUM`                               |
| Serverless | `lambda` & `xray`                   |
| Appsec     | `appsec`                            |

[1]: /tracing/setup_overview/setup/
[2]: /tracing/visualization/#trace-root-span
[3]: /tracing/trace_ingestion/control_page
